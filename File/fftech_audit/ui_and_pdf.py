
# fftech_audit/ui_and_pdf.py
from reportlab.lib.pagesizes import A4
from reportlab.pdfgen import canvas
from reportlab.lib import colors
from reportlab.graphics.shapes import Drawing
from reportlab.graphics.charts.barcharts import VerticalBarChart
from io import BytesIO

BRAND_TITLE = "FF Tech AI Website Audit"

def _header(c, subtitle=None):
    c.setFillColor(colors.HexColor('#222831')); c.rect(0, A4[1]-40, A4[0], 40, fill=1, stroke=0)
    c.setFillColor(colors.white); c.setFont('Helvetica-Bold', 14)
    c.drawString(20, A4[1]-28, BRAND_TITLE)
    if subtitle: c.setFont('Helvetica', 10); c.drawString(20, A4[1]-42, subtitle)

def _footer_conclusion(c, text="Conclusion: Scores reflect standardized weights across Security, Performance, SEO, Mobile, and Content."):
    c.setFont('Helvetica', 9); c.setFillColor(colors.HexColor('#666'))
    c.drawString(20, 30, text)

def _bar_chart(labels, values):
    d = Drawing(400, 200); bc = VerticalBarChart()
    bc.x=30; bc.y=30; bc.height=140; bc.width=340
    bc.data=[values]; bc.valueAxis.valueMin=0; bc.valueAxis.valueMax=100; bc.valueAxis.valueStep=20
    bc.categoryAxis.categoryNames=labels; bc.bars[0].fillColor=colors.HexColor('#00ADB5')
    d.add(bc); return d

def build_pdf_report(audit, category_scores, strengths, weaknesses, priority_fixes) -> bytes:
    buf = BytesIO(); c = canvas.Canvas(buf, pagesize=A4)

    # Page 1: Cover & Executive summary
    _header(c, 'Certified Audit Report')
    c.setFillColor(colors.black)
    c.setFont('Helvetica-Bold', 16); c.drawString(40, 760, f"Overall Score: {audit.score}% | Grade: {audit.grade}")
    c.setFont('Helvetica', 12); c.drawString(40, 740, f"Audited URL: {audit.url}")
    c.setFont('Helvetica', 11); c.drawString(40, 710, "Executive Summary:")
    t = c.beginText(40, 690); t.setFont('Helvetica', 10)
    t.textLines("This executive report summarizes website health across security, performance, SEO, mobile, and content. It highlights critical fixes and growth opportunities.")
    c.drawText(t); _footer_conclusion(c); c.showPage()

    # Page 2: Category Breakdown (chart)
    _header(c, 'Category Breakdown')
    labels=['Security','Performance','SEO','Mobile','Content']
    values=[category_scores.get(k,0) for k in ['security','performance','seo','mobile','content']]
    chart=_bar_chart(labels, values); chart.drawOn(c, 40, 480)
    c.setFont('Helvetica', 11); c.drawString(40, 450, 'Scores are normalized 0–100 with industry weights applied.')
    _footer_conclusion(c); c.showPage()

    # Page 3: Strengths & Weak Areas
    _header(c, 'Strengths & Weak Areas')
    c.setFont('Helvetica-Bold', 12); c.drawString(40, 760, 'Strengths'); c.setFont('Helvetica', 10)
    y=740
    for s in (strengths or []): c.drawString(50, y, f"• {s}"); y -= 16
    c.setFont('Helvetica-Bold', 12); c.drawString(320, 760, 'Weak Areas'); c.setFont('Helvetica', 10); y=740
    for w in (weaknesses or []): c.drawString(330, y, f"• {w}"); y -= 16
    _footer_conclusion(c); c.showPage()

    # Page 4: Priority Fixes
    _header(c, 'Priority Fixes')
    c.setFont('Helvetica', 10); y=740
    for p in (priority_fixes or []): c.drawString(50, y, f"• {p}"); y -= 18
    _footer_conclusion(c); c.showPage()

    # Page 5: Certification
    _header(c, 'Conclusion & Certification')
    c.setFont('Helvetica', 11); c.drawString(40, 760, 'Certified Export Readiness: YES')
    c.setFont('Helvetica', 10); c.drawString(40, 740, 'Generated by FF Tech AI Website Audit SaaS')
    _footer_conclusion(c); c.showPage()

    c.save(); pdf_bytes = buf.getvalue(); buf.close(); return pdf_bytes
