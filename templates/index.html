<script>
    async function runAudit() {
        const results = document.getElementById('results');
        results.classList.add('hidden');
        const url = document.getElementById('url').value.trim();
        if (!url) return alert('Please enter a domain');

        const btn = document.getElementById('btn');
        btn.innerText = 'Auditing...';
        btn.disabled = true;

        try {
            const res = await fetch('/audit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({url})
            });

            const data = await res.json();

            if (res.ok) {
                const d = data.data;
                results.classList.remove('hidden');

                // Populate top cards
                document.getElementById('revLoss').innerText = `-${d.financial_data.estimated_revenue_leak}`;
                document.getElementById('revGain').innerText = `+${d.financial_data.potential_recovery_gain}`;
                document.getElementById('lcpVal').innerText = d.metrics['04. Largest Contentful Paint (LCP)']?.val || 'N/A';
                document.getElementById('grade').innerText = d.grade;
                document.getElementById('score').innerText = `${d.score}%`;
                document.getElementById('dl').href = `/download/${data.id}`;

                // Broken links
                const brokenBox = document.getElementById('brokenBox');
                if (d.broken_links && d.broken_links.length > 0) {
                    brokenBox.classList.remove('hidden');
                    document.getElementById('brokenList').innerHTML = d.broken_links.map(l => `<div>• ${l}</div>`).join('');
                } else {
                    brokenBox.classList.add('hidden');
                }

                // All 57 metrics
                let grid = "";
                Object.entries(d.metrics).forEach(([key, val]) => {
                    const color = val.status === 'PASS' ? 'text-green-400' : val.status === 'WARN' ? 'text-yellow-400' : 'text-red-400';
                    grid += `
                        <div class="glass rounded-2xl p-6 metric-card">
                            <div class="text-xs text-slate-400 uppercase tracking-wide mb-2">${key}</div>
                            <div class="text-xl font-bold ${color} mb-1">${val.val}</div>
                            <div class="text-sm text-slate-500 mb-2">${val.status} (${val.score}%)</div>
                            <p class="text-xs text-slate-400 mb-2">Explanation: ${val.explanation || 'N/A'}</p>
                            <p class="text-xs text-slate-300">Recommendation: ${val.recommendation || 'N/A'}</p>
                        </div>`;
                });
                document.getElementById('metricsGrid').innerHTML = grid;

            } else {
                // Better error from backend
                alert(data.detail || 'Audit failed – site may be down or blocking automated scans.');
            }
        } catch (err) {
            // Network or server error – friendly message
            alert('Connection error or server issue. Please try again in a few moments.\n\nNote: Some sites (like BBC, Amazon) block automated audits.');
            console.error(err);
        } finally {
            btn.innerText = 'Start Comprehensive Audit';
            btn.disabled = false;
        }
    }
</script>
