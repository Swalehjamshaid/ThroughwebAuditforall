<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FF TECH ELITE v3 | Global Audit Standard</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&family=JetBrains+Mono&display=swap" rel="stylesheet">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { 
            sans: ['Outfit', 'system-ui'],
            mono: ['JetBrains Mono', 'monospace']
          },
          colors: {
            brand: { 
                50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1',
                accent: '#6366f1', gold: '#fbbf24'
            },
          },
          boxShadow: {
            'glow': '0 0 20px -5px rgba(14, 165, 233, 0.5)',
            'premium': '0 20px 50px -12px rgba(0, 0, 0, 0.1)',
          }
        }
      }
    };
  </script>

  <style>
    :root { --p: 0deg; }
    
    /* Global Aesthetic */
    .bg-grid {
        background-size: 30px 30px;
        background-image: linear-gradient(to right, rgba(0,0,0,0.03) 1px, transparent 1px), 
                          linear-gradient(to bottom, rgba(0,0,0,0.03) 1px, transparent 1px);
    }

    /* Executive Gauge */
    .gauge {
      width: 180px; height: 180px; border-radius: 50%;
      background: conic-gradient(from 0deg, #0ea5e9 var(--p), #6366f1 var(--p), #f1f5f9 0);
      position: relative;
      display: flex; align-items: center; justify-content: center;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
    }
    .gauge::after { content: ''; position: absolute; inset: 12px; background: white; border-radius: 50%; z-index: 1; }
    .dark .gauge::after { background: #0f172a; }
    .gauge-label { z-index: 2; font-weight: 900; font-size: 2.5rem; letter-spacing: -2px; }

    /* Glass Panels */
    .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.4); }
    .dark .glass { background: rgba(15, 23, 42, 0.9); border: 1px solid rgba(255, 255, 255, 0.05); }

    /* Premium Button Shimmer */
    .btn-shimmer {
        position: relative; overflow: hidden;
        background: linear-gradient(90deg, #0ea5e9, #6366f1);
    }
    .btn-shimmer::before {
        content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.2), transparent);
        transform: rotate(45deg); animation: shimmer 3s infinite;
    }
    @keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }

    /* PDF Print Styles (The "Beautiful Export" secret) */
    @media print {
        body { background: white !important; color: black !important; }
        .no-print { display: none !important; }
        .glass { border: 1px solid #e2e8f0 !important; backdrop-filter: none !important; box-shadow: none !important; }
        .gauge { -webkit-print-color-adjust: exact; }
    }
  </style>
</head>

<body class="h-full bg-white dark:bg-[#020617] text-slate-900 dark:text-slate-100 bg-grid">

  <nav class="sticky top-4 z-50 mx-auto max-w-7xl px-4 no-print">
    <div class="glass rounded-3xl px-8 py-4 flex items-center justify-between shadow-premium">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-black dark:bg-brand-600 rounded-2xl flex items-center justify-center shadow-glow">
          <svg class="w-7 h-7 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
        </div>
        <div>
          <h1 class="text-2xl font-black tracking-tighter uppercase italic">FF TECH <span class="text-brand-600">ELITE</span></h1>
          <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest leading-none">Global SEO Protocol v3.0</p>
        </div>
      </div>
      <button id="toggleDark" class="p-3 rounded-2xl bg-slate-100 dark:bg-slate-800 transition-transform active:scale-90">
         <svg id="themeIcon" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0z"/></svg>
      </button>
    </div>
  </nav>

  <main class="mx-auto max-w-7xl p-4 sm:p-6 lg:p-8 space-y-10">
    
    <section class="glass rounded-[2rem] p-10 shadow-2xl no-print relative overflow-hidden">
        <div class="absolute top-0 right-0 p-8 opacity-10">
            <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10 items-end">
            <div class="lg:col-span-7 space-y-4">
                <label class="text-xs font-black uppercase tracking-[0.2em] text-brand-600">Target Environment</label>
                <input id="url" type="url" placeholder="https://your-empire.com" 
                       class="w-full bg-slate-50 dark:bg-slate-900 border-2 border-slate-100 dark:border-slate-800 focus:border-brand-500 rounded-2xl px-6 py-5 text-xl font-bold outline-none transition-all" />
            </div>
            <div class="lg:col-span-5 flex gap-4">
                <button id="runAudit" class="flex-1 btn-shimmer text-white font-black uppercase tracking-widest rounded-2xl py-5 shadow-2xl hover:scale-[1.02] transition-all flex items-center justify-center gap-3">
                    Execute Scan
                    <div id="loading" class="hidden w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                </button>
                <button id="downloadPdf" disabled class="px-6 bg-white dark:bg-slate-800 border-2 border-slate-100 dark:border-slate-800 rounded-2xl hover:bg-slate-50 transition-all disabled:opacity-20">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                </button>
            </div>
        </div>
        <p id="status" class="mt-6 font-mono text-[10px] font-bold text-slate-400 uppercase tracking-widest"></p>
    </section>

    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        <div class="lg:col-span-4 glass rounded-[2.5rem] p-10 flex flex-col items-center text-center justify-center">
            <h3 class="text-xs font-black uppercase tracking-[0.3em] text-slate-400 mb-10">Health Index</h3>
            <div id="gauge" class="gauge mb-10">
                <div class="gauge-label"><span id="overallScore">0%</span></div>
            </div>
            <p id="auditedAt" class="font-mono text-[10px] font-bold text-brand-600 mb-2"></p>
            <p id="summaryText" class="text-sm font-medium text-slate-500 leading-relaxed italic"></p>
        </div>

        <div class="lg:col-span-8 glass rounded-[2.5rem] p-10">
            <h3 class="text-xs font-black uppercase tracking-[0.3em] text-slate-400 mb-10">Core Pillar Distribution</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-12">
                <div class="space-y-3">
                    <p class="text-[10px] font-black text-emerald-500 uppercase">Performance</p>
                    <p id="pillPerfVal" class="text-3xl font-black">0%</p>
                    <div class="h-1.5 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div id="pillPerfBar" class="h-full bg-emerald-500 transition-all duration-1000" style="width:0%"></div>
                    </div>
                </div>
                <div class="space-y-3">
                    <p class="text-[10px] font-black text-sky-500 uppercase">SEO Strength</p>
                    <p id="pillSeoVal" class="text-3xl font-black">0%</p>
                    <div class="h-1.5 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div id="pillSeoBar" class="h-full bg-sky-500 transition-all duration-1000" style="width:0%"></div>
                    </div>
                </div>
                <div class="space-y-3">
                    <p class="text-[10px] font-black text-indigo-500 uppercase">UX Design</p>
                    <p id="pillUxVal" class="text-3xl font-black">0%</p>
                    <div class="h-1.5 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div id="pillUxBar" class="h-full bg-indigo-500 transition-all duration-1000" style="width:0%"></div>
                    </div>
                </div>
                <div class="space-y-3">
                    <p class="text-[10px] font-black text-rose-500 uppercase">Security</p>
                    <p id="pillSecVal" class="text-3xl font-black">0%</p>
                    <div class="h-1.5 w-full bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div id="pillSecBar" class="h-full bg-rose-500 transition-all duration-1000" style="width:0%"></div>
                    </div>
                </div>
            </div>
            <div class="h-[250px]">
                <canvas id="pillarsChart"></canvas>
            </div>
        </div>
    </div>

    <section class="glass rounded-[2.5rem] p-12">
        <div class="flex items-center gap-6 mb-10">
            <div class="w-14 h-14 rounded-3xl bg-brand-gold/10 flex items-center justify-center text-brand-gold shadow-inner">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            </div>
            <div>
                <h3 class="text-2xl font-black tracking-tight uppercase italic">Strategic Roadmap</h3>
                <p class="text-xs font-bold text-slate-400 uppercase tracking-widest">Prioritized Optimization Steps</p>
            </div>
        </div>
        <ul id="roadmapList" class="grid grid-cols-1 md:grid-cols-2 gap-6"></ul>
    </section>

    <section class="glass rounded-[2.5rem] overflow-hidden shadow-2xl">
        <div class="p-10 border-b border-slate-100 dark:border-slate-800 bg-slate-50/30 dark:bg-slate-900/30">
            <h3 class="text-xl font-black uppercase italic tracking-tighter">Diagnostic Ledger</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-slate-50 dark:bg-slate-900 text-[10px] font-black uppercase tracking-widest text-slate-400">
                    <tr>
                        <th class="px-10 py-5">Analysis Node</th>
                        <th class="px-10 py-5">Stream</th>
                        <th class="px-10 py-5">Efficiency</th>
                        <th class="px-10 py-5 text-right">Impact</th>
                    </tr>
                </thead>
                <tbody id="metricsBody" class="divide-y divide-slate-100 dark:divide-slate-800 font-medium"></tbody>
            </table>
        </div>
    </section>

    <section id="seoSection" class="hidden">
        <div class="glass rounded-[3rem] p-12 border-b-8 border-brand-600">
            <div class="flex items-center justify-between mb-12">
                <div>
                    <h2 class="text-4xl font-black tracking-tighter uppercase italic">SEO Intelligence</h2>
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mt-2">Neural Domain Analysis</p>
                </div>
                <button id="toggleSeo" class="bg-black text-white px-8 py-3 rounded-2xl text-xs font-black uppercase tracking-widest hover:bg-brand-600 transition-all">Deep Analysis</button>
            </div>
            
            <div id="seoBody" class="hidden space-y-16">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="p-8 rounded-[2rem] bg-slate-50 dark:bg-slate-900/50 border border-slate-100 dark:border-slate-800">
                        <p class="text-[10px] font-black text-slate-400 uppercase mb-2">Subject</p>
                        <p id="seoDomain" class="text-lg font-black break-all">—</p>
                    </div>
                    <div class="p-8 rounded-[2rem] bg-slate-50 dark:bg-slate-900/50 border border-slate-100 dark:border-slate-800">
                        <p class="text-[10px] font-black text-slate-400 uppercase mb-2">Authority Score</p>
                        <p id="seoScore" class="text-3xl font-black text-brand-600">—</p>
                    </div>
                    <div class="p-8 rounded-[2rem] bg-rose-500/5 border border-rose-500/20">
                        <p class="text-[10px] font-black text-rose-500 uppercase mb-2">Critical Anomalies</p>
                        <p id="seoIssues" class="text-lg font-black text-rose-600">—</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                    <div class="space-y-6">
                        <h4 class="text-xs font-black uppercase text-slate-400 tracking-[0.3em]">System Faults</h4>
                        <div class="rounded-3xl border border-slate-100 dark:border-slate-800 overflow-hidden">
                            <table class="w-full text-xs"><tbody id="seoIssuesBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody></table>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <h4 class="text-xs font-black uppercase text-slate-400 tracking-[0.3em]">Market Keywords</h4>
                        <div class="rounded-3xl border border-slate-100 dark:border-slate-800 overflow-hidden">
                            <table class="w-full text-xs"><tbody id="seoKeywordsBody" class="divide-y divide-slate-100 dark:divide-slate-800"></tbody></table>
                        </div>
                    </div>
                </div>

                <div id="onPageGrid" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
            </div>
        </div>
    </section>

  </main>

  <script>
    // Logic Engines (Preserved and Enhanced)
    const fmt = n => (n ?? n === 0) ? n.toLocaleString() : '—';
    const clamp = v => Math.max(0, Math.min(100, Math.round(v || 0)));
    const decodeEntities = (s) => { const e = document.createElement('textarea'); e.innerHTML = (s || '').toString(); return e.value; };
    const scoreColor = (score) => { if (score >= 90) return 'bg-emerald-500'; if (score >= 80) return 'bg-sky-500'; if (score >= 60) return 'bg-amber-500'; return 'bg-rose-500'; };
    const catBadge = (cat) => ({ 'Performance':'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-200', 'SEO':'bg-sky-100 text-sky-700 dark:bg-sky-900/30 dark:text-sky-200', 'UX':'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-200', 'Security':'bg-rose-100 text-rose-700 dark:bg-rose-900/30 dark:text-rose-200', }[cat] || 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-100');

    let currentAudit = null;
    let pillarsChartInstance = null;
    let seoSectionsChartInstance = null;
    let cwvRadarInstance = null;

    document.getElementById('toggleDark').addEventListener('click', () => {
      document.documentElement.classList.toggle('dark');
    });

    document.getElementById('runAudit').addEventListener('click', runAudit);
    document.getElementById('downloadPdf').addEventListener('click', downloadPdf);
    document.getElementById('toggleSeo').addEventListener('click', () => {
      const b = document.getElementById('seoBody');
      const btn = document.getElementById('toggleSeo');
      const open = b.classList.contains('hidden');
      b.classList.toggle('hidden', !open);
      btn.textContent = open ? 'Collapse Report' : 'Deep Report';
    });

    async function runAudit() {
      const url = document.getElementById('url').value.trim();
      const modeSel = document.getElementById('mode')?.value || 'desktop';
      const status = document.getElementById('status');
      const loading = document.getElementById('loading');
      const dlBtn = document.getElementById('downloadPdf');

      status.textContent = 'PROTOCOL INITIATED: SCANNING DOMAIN...';
      loading.classList.remove('hidden');

      try {
        const res = await fetch('/audit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, mode: modeSel })
        });
        if (!res.ok) throw new Error(`SYSTEM ERROR ${res.status}`);
        const data = await res.json();
        currentAudit = data;
        renderAll(data);
        status.textContent = `ANALYSIS COMPLETE: ${data.url}`;
        dlBtn.disabled = false;
      } catch (e) {
        status.textContent = `CRITICAL ERROR: ${e.message}`;
      } finally {
        loading.classList.add('hidden');
      }
    }

    async function downloadPdf() {
      if (!currentAudit) return;
      document.getElementById('status').textContent = 'COMPILING EXECUTIVE PDF LEDGER...';
      try {
        const res = await fetch('/download', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(currentAudit)
        });
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `FF_ELITE_AUDIT_${Date.now()}.pdf`;
        document.body.appendChild(a); a.click(); a.remove();
        document.getElementById('status').textContent = 'EXECUTIVE REPORT EXPORTED.';
      } catch (e) { document.getElementById('status').textContent = 'EXPORT SEQUENCE FAILED.'; }
    }

    function renderAll(d) {
      const pct = clamp(d.total_grade);
      document.getElementById('overallScore').textContent = `${pct}%`;
      document.getElementById('gauge').style.setProperty('--p', `${pct * 3.6}deg`);
      document.getElementById('auditedAt').textContent = `INDEXED: ${d.audited_at || 'REAL-TIME'}`;
      document.getElementById('summaryText').textContent = d.summary || '';

      const p = d.pillars || {};
      setBar('pillPerfBar', 'pillPerfVal', p['Performance']);
      setBar('pillSeoBar', 'pillSeoVal', p['SEO']);
      setBar('pillUxBar', 'pillUxVal', p['UX']);
      setBar('pillSecBar', 'pillSecVal', p['Security']);
      
      renderPillarsChart(p);
      renderMetricsTable(d.metrics || []);
      renderRoadmap(d.roadmap || '');

      if (d.seo_audit) {
        renderSeoAudit(d.seo_audit);
        document.getElementById('seoSection').classList.remove('hidden');
      }
    }

    function setBar(barId, valId, score) {
      const s = clamp(score || 0);
      document.getElementById(barId).style.width = `${s}%`;
      document.getElementById(valId).textContent = `${s}%`;
    }

    function renderPillarsChart(p) {
      const ctx = document.getElementById('pillarsChart').getContext('2d');
      if (pillarsChartInstance) pillarsChartInstance.destroy();
      pillarsChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['PERFORMANCE', 'SEO', 'UX', 'SECURITY'],
          datasets: [{
            data: [clamp(p['Performance']), clamp(p['SEO']), clamp(p['UX']), clamp(p['Security'])],
            backgroundColor: ['#10b981','#0ea5e9','#6366f1','#f43f5e'],
            borderRadius: 15
          }]
        },
        options: { 
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: { y: { display: false }, x: { grid: { display: false } } }
        }
      });
    }

    function renderMetricsTable(metrics) {
      const body = document.getElementById('metricsBody');
      body.innerHTML = metrics.slice(0, 15).map(m => {
        const s = clamp(m.score);
        return `
          <tr class="hover:bg-slate-50/50 dark:hover:bg-slate-800/50 transition-colors">
            <td class="px-10 py-6 font-bold uppercase tracking-tighter">${m.name}</td>
            <td class="px-10 py-6"><span class="px-3 py-1 rounded-xl text-[9px] font-black uppercase ${catBadge(m.category)}">${m.category}</span></td>
            <td class="px-10 py-6">
              <div class="flex items-center gap-4">
                <div class="h-1.5 w-24 rounded-full bg-slate-100 dark:bg-slate-800"><div class="h-full ${scoreColor(s)}" style="width:${s}%"></div></div>
                <span class="text-xs font-black">${s}%</span>
              </div>
            </td>
            <td class="px-10 py-6 text-right font-mono text-[10px] text-slate-400 font-bold">${fmt(m.weight)}</td>
          </tr>
        `;
      }).join('');
    }

    function renderRoadmap(html) {
      const list = document.getElementById('roadmapList');
      const lines = decodeEntities(html).split('<br/>').map(x => x.trim()).filter(x => x && !x.toLowerCase().includes('<b>'));
      list.innerHTML = lines.map(it => `
        <li class="flex items-start gap-4 p-6 rounded-[1.5rem] bg-slate-50 dark:bg-slate-900 border border-slate-100 dark:border-slate-800 text-[11px] font-bold leading-relaxed uppercase tracking-wide">
            <span class="w-2 h-2 rounded-full bg-brand-gold mt-1.5 shrink-0 shadow-lg shadow-brand-gold/50"></span>
            ${it.replace(/^\d+\.\s*/, '')}
        </li>
      `).join('');
    }

    function renderSeoAudit(seo) {
      document.getElementById('seoDomain').textContent = seo.domain || 'SYSTEM SUBJECT 01';
      document.getElementById('seoScore').textContent = `${fmt(seo.seo_score)}/100`;
      document.getElementById('seoIssues').textContent = `${fmt(seo.critical_issues)} CRITICAL FAULTS`;

      document.getElementById('seoIssuesBody').innerHTML = (seo.issues || []).map(i => `
        <tr class="hover:bg-rose-500/5">
          <td class="px-6 py-4 font-black uppercase text-rose-500">${i.type}</td>
          <td class="px-6 py-4 font-mono font-bold text-slate-400">${i.priority}</td>
          <td class="px-6 py-4 text-slate-500 font-medium">${i.message}</td>
        </tr>
      `).join('');

      document.getElementById('seoKeywordsBody').innerHTML = (seo.keyword_rankings || []).slice(0,8).map(k => `
        <tr><td class="px-6 py-4 font-black uppercase tracking-tighter">${k.keyword}</td><td class="px-6 py-4 text-right font-mono text-brand-600 font-black">#${k.rank}</td><td class="px-6 py-4 text-right font-bold text-slate-400">${fmt(k.volume)}</td></tr>
      `).join('');

      document.getElementById('onPageGrid').innerHTML = [
        {l:'Protocol Title', v:seo.on_page?.title?.value},
        {l:'Primary Header', v:seo.on_page?.h1?.value},
        {l:'Endpoint URL', v:seo.on_page?.url?.value}
      ].map(x => `
        <div class="p-8 rounded-[2rem] bg-slate-50 dark:bg-slate-900/50 border border-slate-100 dark:border-slate-800">
          <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-4">${x.l}</p>
          <p class="font-bold text-sm break-all leading-tight">${x.v || 'NONE DETECTED'}</p>
        </div>
      `).join('');
    }

    // Default target
    document.getElementById('url').value = 'https://haier.com.pk';
  </script>
</body>
</html>
