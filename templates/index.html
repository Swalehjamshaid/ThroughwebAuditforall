
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>FF Tech SaaS Audit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 CSS -->
  https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css
  <!-- Chart.js -->
  https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js</script>
  <style>
    body { background: #0f172a; color: #e2e8f0; }
    .navbar { background: #1e293b; }
    .card { background: #111827; color: #e2e8f0; border: 1px solid #334155; }
    .btn-primary { background:#2563eb; border-color:#1d4ed8; }
    .btn-outline-secondary { color:#e2e8f0; border-color:#334155; }
   fd; }
    .brand { font-weight: 700; letter-spacing: .4px; }
    .hidden { display:none; }
  </style>
</head>
<body>
<nav class="navbar navbar-dark">
  <div class="container">
    <span class="navbar-brand brand">FF Tech</span>
    <div id="navActions">
      #Login</a>
      #Register</a>
    </div>
  </div>
</nav>

<main class="container py-4">
  <div id="alerts"></div>

  <!-- Login View -->
  <div id="loginView" class="hidden">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card p-4">
          <h3 class="mb-3">Sign In</h3>
          <form id="loginForm">
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="loginEmail" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" id="loginPassword" required>
            </div>
            <button class="btn btn-primary w-100" type="submit">Login</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Register View -->
  <div id="registerView" class="hidden">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card p-4">
          <h3 class="mb-3">Create Account</h3>
          <form id="registerForm">
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" id="regEmail" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Password</label>
              <input type="password" class="form-control" id="regPassword" minlength="8" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Timezone</label>
              <input type="text" class="form-control" id="regTimezone" value="Asia/Karachi">
            </div>
            <button class="btn btn-primary w-100" type="submit">Register</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard View -->
  <div id="dashboardView" class="hidden">
    <div class="d-flex justify-content-between mb-3">
      <h3>Dashboard</h3>
      <button class="btn btn-outline-light btn-sm" onclick="logout()">Logout</button>
    </div>
    <div class="row">
      <div class="col-lg-4">
        <div class="card p-3 mb-4">
          <h5>Add Website</h5>
          <form id="addWebsiteForm">
            <input type="url" class="form-control mb-2" id="siteUrl" placeholder="https://example.com" required>
            <button class="btn btn-primary w-100">Save</button>
          </form>
        </div>
        <div class="card p-3 mb-4">
          <h5>Schedule Daily Email</h5>
          <form id="scheduleForm">
            <select class="form-select mb-2" id="schedWebsite"></select>
            <div class="row">
              <div class="col"><input type="number" class="form-control" id="schedHour" min="0" max="23" value="9"></div>
              <div class="col"><input type="number" class="form-control" id="schedMinute" min="0" max="59" value="0"></div>
            </div>
            <button class="btn btn-primary w-100 mt-2">Create Schedule</button>
          </form>
          <ul id="scheduleList" class="small mt-2"></ul>
        </div>
      </div>
      <div class="col-lg-8">
        <div class="card p-3 mb-4">
          <h5>Websites</h5>
          <table class="table table-dark table-striped">
            <thead><tr><th>#</th><th>URL</th><th>Actions</th></tr></thead>
            <tbody id="websitesTableBody"></tbody>
          </table>
        </div>
        <div class="card p-3">
          <h5>Latest Audit Summary</h5>
          <div id="latestArea"></div>
          <hr>
          <canvas id="trendChart" height="90"></canvas>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
const BASE_URL = ""; // e.g., "https://yourapp.up.railway.app"
let token = localStorage.getItem('fftech_token');

function showView(view) {
  document.querySelectorAll('#loginView,#registerView,#dashboardView').forEach(el => el.classList.add('hidden'));
  document.getElementById(view+'View').classList.remove('hidden');
}

function showAlert(msg,type='info') {
  document.getElementById('alerts').innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
  setTimeout(()=>document.getElementById('alerts').innerHTML='',4000);
}

async function api(path, options={}) {
  const res = await fetch(`${BASE_URL}${path}`, {
    ...options,
    headers: {
      'Authorization': token ? `Bearer ${token}` : '',
      ...(options.headers||{})
    }
  });
  if (!res.ok) throw new Error(await res.text());
  return res.headers.get('content-type').includes('json') ? res.json() : res.blob();
}

// Login
document.getElementById('loginForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const email=document.getElementById('loginEmail').value.trim();
  const password=document.getElementById('loginPassword').value;
  try {
    const data=await fetch(`${BASE_URL}/auth/login`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email,password})
    }).then(r=>r.json());
    token=data.access_token;
    localStorage.setItem('fftech_token',token);
    showView('dashboard');
    loadDashboard();
  }catch(err){showAlert('Login failed','danger');}
});

// Register
document.getElementById('registerForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const email=document.getElementById('regEmail').value.trim();
  const password=document.getElementById('regPassword').value;
  const timezone=document.getElementById('regTimezone').value;
  try {
    const res=await fetch(`${BASE_URL}/auth/register`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({email,password,timezone})
    });
    const data=await res.json();
    showAlert(data.message,'success');
    showView('login');
  }catch(err){showAlert('Registration failed','danger');}
});

function logout(){localStorage.removeItem('fftech_token');token=null;showView('login');}

// Dashboard logic
async function loadDashboard(){
  try{
    const me=await api('/auth/me');
    document.getElementById('navActions').innerHTML=`<span class="me-3 small">Signed in as ${me.email}</span>`;
    const websites=await api('/websites');
    const tbody=document.getElementById('websitesTableBody');
    const schedSel=document.getElementById('schedWebsite');
    tbody.innerHTML='';schedSel.innerHTML='';
    websites.forEach(w=>{
      schedSel.add(new Option(w.url,w.id));
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${w.id}</td><td>${w.url}</td>
      <td><button class="btn btn-sm btn-primary" onclick="runAudit(${w.id})">Run Audit</button>
      <button class="btn btn-sm btn-outline-secondary" onclick="downloadPDF(${w.id})">Download PDF</button></td>`;
      tbody.appendChild(tr);
    });
    if(websites.length) loadLatest(websites[0].id);
    loadSchedules();
  }catch(err){showAlert('Failed to load dashboard','danger');}
}

async function runAudit(id){
  try{
    const res=await api('/audit/run',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({website_id:id})});
    showAlert(`Audit done: Grade ${res.grade}, Score ${res.score}%`,'success');
    loadLatest(id);
  }catch(err){showAlert('Audit failed','danger');}
}

async function downloadPDF(id){
  try{
    const latest=await api(`/audit/website/${id}/latest`);
    const auditId=latest.audit_id;
    const blob=await api(`/audit/${auditId}/pdf`);
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');a.href=url;a.download=`FFTech_Audit_${auditId}.pdf`;a.click();
    URL.revokeObjectURL(url);
  }catch(err){showAlert('Download failed','danger');}
}

async function loadLatest(id){
  try{
    const latest=await api(`/audit/website/${id}/latest`);
    const m=latest.metrics;
    document.getElementById('latestArea').innerHTML=`
      <p><strong>Grade:</strong> ${latest.grade} | <strong>Score:</strong> ${latest.score}%</p>
      <p>Errors: ${m.total_errors}, Warnings: ${m.total_warnings}, Notices: ${m.total_notices}</p>
      <p class="small">${latest.executive_summary}</p>
      <canvas id="distChart" height="120"></canvas>`;
    new Chart(document.getElementById('distChart'),{
      type:'pie',data:{labels:['Errors','Warnings','Notices'],datasets:[{data:[m.total_errors,m.total_warnings,m.total_notices],backgroundColor:['#ef4444','#f59e0b','#22c55e']}]}
    });
    const acc=await api(`/audit/website/${id}/accumulated`);
    const labels=acc.trend.map(t=>t.date?t.date.slice(0,10):`Run ${t.id}`);
    const scores=acc.trend.map(t=>t.score);
    new Chart(document.getElementById('trendChart'),{
      type:'line',data:{labels,datasets:[{label:'Site Health Score (%)',data:scores,borderColor:'#93c5fd',tension:0.25}]},
      options:{scales:{y:{suggestedMin:0,suggestedMax:100}}}
    });
  }catch(err){document.getElementById('latestArea').innerHTML='<p>No audits yet.</p>';}
}

async function loadSchedules(){
  const items=await api('/schedules');
  document.getElementById('scheduleList').innerHTML=items.map(s=>`<li>#${s.id} â€¢ ${s.cron}</li>`).join('');
}

document.getElementById('addWebsiteForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const url=document.getElementById('siteUrl').value.trim();
  try{await api('/websites',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url})});
    showAlert('Website added','success');loadDashboard();
  }catch(err){showAlert('Failed to add website','danger');}
});

document.getElementById('scheduleForm').addEventListener('submit',async e=>{
  e.preventDefault();
  const website_id=Number(document.getElementById('schedWebsite').value);
  const hour_24=Number(document.getElementById('schedHour').value);
  const minute=Number(document.getElementById('schedMinute').value);
  try{await api('/schedules',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({website_id,hour_24,minute})});
    showAlert('Schedule created','success');loadSchedules();
  }catch(err){showAlert('Failed to create schedule','danger');}
});

// Init view
if(token){showView('dashboard');loadDashboard();}else{showView('login');}
</script>
</body>
</html>
