<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FF TECH ELITE v3 - Enterprise Web Audit</title>
    <style>
        :root {
            --color-bg: #0f172a;
            --color-bg-light: #1e293b;
            --color-bg-lighter: #334155;
            --color-border: #475569;
            --color-text: #e2e8f0;
            --color-text-muted: #94a3b8;
            --color-primary: #10b981;
            --color-accent: #0ea5e9;
            --color-red: #ef4444;
            --color-yellow: #f59e0b;
            --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            font-size: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }

        header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
        }

        header h1 span {
            color: var(--color-primary);
        }

        header p {
            font-size: 1.1rem;
            color: var(--color-text-muted);
            margin-top: 0.5rem;
        }

        .card {
            background-color: var(--color-bg-light);
            border-radius: 12px;
            padding: 2rem;
            border: 1px solid var(--color-border);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .input-wrapper {
            position: relative;
            width: 100%;
        }

        .url-input {
            width: 100%;
            padding: 1rem 1rem 1rem 2.5rem;
            background-color: var(--color-bg);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            color: var(--color-text);
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .url-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3);
        }

        .input-wrapper svg {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: var(--color-text-muted);
        }

        .form-controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
        }

        .mode-selector {
            display: flex;
            gap: 1rem;
            background-color: var(--color-bg);
            padding: 0.5rem;
            border-radius: 8px;
            border: 1px solid var(--color-border);
        }

        .mode-selector label {
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            color: var(--color-text-muted);
            font-weight: 500;
        }

        .mode-selector input[type="radio"] {
            display: none;
        }

        .mode-selector input[type="radio"]:checked + label {
            background-color: var(--color-primary);
            color: white;
        }

        .btn {
            padding: 0.8rem 1.8rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: #0f9a74;
        }
        
        .btn-secondary {
            background-color: var(--color-accent);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #0b8ac7;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .loader {
            text-align: center;
            padding: 3rem;
        }

        .spinner {
            border: 4px solid var(--color-bg-lighter);
            border-top: 4px solid var(--color-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #results {
            display: grid;
            gap: 2rem;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .score-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .score-circle {
            width: 180px;
            height: 180px;
            border-radius: 50%;
            display: grid;
            place-items: center;
            background: conic-gradient(var(--color-primary) 0deg, var(--color-bg-lighter) 0deg);
            position: relative;
            margin-bottom: 1rem;
        }

        .score-circle::before {
            content: '';
            position: absolute;
            height: 85%;
            width: 85%;
            background: var(--color-bg-light);
            border-radius: 50%;
        }

        .score-value {
            position: relative;
            font-size: 3.5rem;
            font-weight: 700;
        }

        .score-label {
            font-size: 1.2rem;
            color: var(--color-text-muted);
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--color-border);
            color: white;
        }

        .pillar-scores .pillar {
            margin-bottom: 1rem;
        }

        .pillar-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .progress-bar {
            height: 12px;
            background-color: var(--color-bg-lighter);
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-bar-inner {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease-in-out;
        }

        .perf-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
        }

        .perf-metric {
            text-align: center;
            background: var(--color-bg);
            padding: 1rem;
            border-radius: 8px;
        }

        .perf-metric .value {
            font-size: 1.75rem;
            font-weight: 600;
        }

        .perf-metric .label {
            font-size: 0.9rem;
            color: var(--color-text-muted);
        }
        
        .roadmap ul {
            list-style: none;
        }
        
        .roadmap li {
            background-color: var(--color-bg);
            padding: 0.75rem 1rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--color-accent);
        }

        .metrics-table {
            width: 100%;
            border-collapse: collapse;
        }

        .metrics-table th, .metrics-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }
        
        .metrics-table th {
            font-weight: 600;
            background-color: var(--color-bg-lighter);
        }
        
        .metrics-table tr:last-child td {
            border-bottom: none;
        }

        .score-badge {
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-weight: 600;
            color: white;
            font-size: 0.9rem;
        }
        
        .seo-audit-section .sub-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--color-border);
        }
        
        .seo-audit-section .sub-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--color-accent);
            margin-bottom: 1rem;
        }
        
        .seo-audit-section p {
            margin-bottom: 1rem;
            color: var(--color-text-muted);
        }
        
        .seo-audit-section .issue-list li {
            display: flex;
            gap: 1rem;
            align-items: flex-start;
            padding: 0.8rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        
        .priority-tag {
            flex-shrink: 0;
            padding: 0.2rem 0.5rem;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        
        .priority-red-flag { background-color: var(--color-red); color: white; }
        .priority-pass { background-color: var(--color-primary); color: white; }
        .priority-info { background-color: var(--color-accent); color: white; }

        .hidden {
            display: none;
        }
        
        .results-header {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>FF TECH ELITE v3 <span>//</span> Web Audit</h1>
            <p>Enter a URL to generate a comprehensive performance, SEO, UX, and security report.</p>
        </header>

        <main>
            <div class="card">
                <form id="audit-form">
                    <div class="form-group">
                        <div class="input-wrapper">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" />
                            </svg>
                            <input type="url" id="url-input" class="url-input" placeholder="e.g., https://example.com" required>
                        </div>
                        <div class="form-controls">
                            <div class="mode-selector">
                                <input type="radio" id="desktop" name="mode" value="desktop" checked>
                                <label for="desktop">Desktop</label>
                                <input type="radio" id="mobile" name="mode" value="mobile">
                                <label for="mobile">Mobile</label>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                                </svg>
                                Analyze
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <div id="loader" class="loader hidden">
                <div class="spinner"></div>
                <p>Running audit... This may take up to a minute.</p>
            </div>
            
            <div id="error-message" class="card hidden" style="background-color: #4a1d1d; border-color: var(--color-red);">
                <p><strong>Audit Failed:</strong> <span id="error-text"></span></p>
            </div>

            <div id="results" class="hidden"></div>
        </main>
    </div>

    <script>
        const form = document.getElementById('audit-form');
        const loader = document.getElementById('loader');
        const resultsContainer = document.getElementById('results');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        let auditDataStore = null;

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = document.getElementById('url-input').value;
            const mode = document.querySelector('input[name="mode"]:checked').value;

            if (!url) {
                alert('Please enter a valid URL.');
                return;
            }

            // Reset UI
            resultsContainer.classList.add('hidden');
            resultsContainer.innerHTML = '';
            errorMessage.classList.add('hidden');
            loader.classList.remove('hidden');
            auditDataStore = null;

            try {
                const response = await fetch('/audit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url, mode })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `HTTP error! Status: ${response.status}`);
                }

                const data = await response.json();
                auditDataStore = data; // Store data for PDF download
                displayResults(data);

            } catch (error) {
                errorText.textContent = error.message;
                errorMessage.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        });
        
        function getScoreColor(score) {
            if (score >= 90) return 'var(--color-primary)';
            if (score >= 50) return 'var(--color-yellow)';
            return 'var(--color-red)';
        }

        function displayResults(data) {
            resultsContainer.innerHTML = `
                <div class="card">
                    <div class="results-header">
                        <div>
                            <h2 class="section-title">Audit Report for ${data.url}</h2>
                            <p class="text-muted">${data.audited_at}</p>
                        </div>
                        <button id="download-pdf-btn" class="btn btn-secondary">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                            Download PDF
                        </button>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card score-display">
                        <div class="score-circle" id="total-score-circle">
                            <div class="score-value">${data.total_grade}</div>
                        </div>
                        <div class="score-label">Overall Health Score</div>
                    </div>
                    <div class="card pillar-scores">
                        <h3 class="section-title">Pillar Scores</h3>
                        ${Object.entries(data.pillars).map(([pillar, score]) => `
                            <div class="pillar">
                                <div class="pillar-info">
                                    <span>${pillar}</span>
                                    <span>${score}%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-bar-inner" style="width: ${score}%; background-color: ${getScoreColor(score)};"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <div class="card">
                    <h3 class="section-title">Core Performance Metrics</h3>
                    <div class="perf-metrics">
                        ${Object.entries(data.perf).map(([key, value]) => `
                            <div class="perf-metric">
                                <div class="value" style="color: ${getScoreColor(data.metrics.find(m => m.name.toLowerCase().includes(key.split('_'),[object Object],)).score)}">${value !== null ? value : 'N/A'}<span style="font-size: 1rem; color: var(--color-text-muted);">${key.includes('ms') ? 'ms' : (key === 'cls' ? '' : (key.includes('kb') ? 'kb' : ''))}</span></div>
                                <div class="label">${key.replace(/_/g, ' ').toUpperCase()}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="card roadmap">
                    <h3 class="section-title">Improvement Roadmap</h3>
                    ${data.roadmap.replace(/<b>.*?<\/b>/g, '').replace(/<br\/>/g, '')}
                </div>
                
                ${data.seo_audit ? generateSeoAuditHtml(data.seo_audit) : ''}

                <div class="card">
                    <h3 class="section-title">All Metrics</h3>
                    <div style="overflow-x:auto;">
                        <table class="metrics-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Metric</th>
                                    <th>Category</th>
                                    <th>Weight</th>
                                    <th>Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.metrics.map(metric => `
                                    <tr>
                                        <td>${metric.no}</td>
                                        <td>${metric.name}</td>
                                        <td>${metric.category}</td>
                                        <td>${metric.weight}</td>
                                        <td><span class="score-badge" style="background-color: ${getScoreColor(metric.score)};">${metric.score}%</span></td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Animate total score circle
            const circle = document.getElementById('total-score-circle');
            circle.style.background = `conic-gradient(${getScoreColor(data.total_grade)} ${data.total_grade * 3.6}deg, var(--color-bg-lighter) 0deg)`;
            
            // Add event listener for PDF download
            document.getElementById('download-pdf-btn').addEventListener('click', downloadPdf);

            resultsContainer.classList.remove('hidden');
        }
        
        function generateSeoAuditHtml(seo) {
            return `
            <div class="card seo-audit-section">
                <h2 class="section-title">Static SEO Audit for ${seo.domain}</h2>
                <p>${seo.overview_text}</p>
                
                <div class="sub-section">
                    <h3 class="sub-title">Critical & Minor Issues</h3>
                    <ul class="issue-list">
                    ${seo.issues.slice(0, 5).map(issue => `
                        <li>
                            <span class="priority-tag priority-${issue.priority.replace(' ', '-')}">${issue.priority}</span>
                            <div><strong>${issue.element}:</strong> ${issue.message}</div>
                        </li>
                    `).join('')}
                    ${seo.issues.length > 5 ? '<li>...and ' + (seo.issues.length - 5) + ' more.</li>' : ''}
                    </ul>
                </div>
                
                <div class="sub-section">
                    <h3 class="sub-title">On-Page SEO Breakdown</h3>
                     <table class="metrics-table">
                        <tbody>
                            <tr><td><strong>Title</strong></td> <td style="color:${seo.on_page.title.priority === 'red-flag' ? 'var(--color-red)' : 'inherit'}">${seo.on_page.title.note}</td></tr>
                            <tr><td><strong>Meta Description</strong></td> <td style="color:${seo.on_page.meta_description.priority === 'red-flag' ? 'var(--color-red)' : 'inherit'}">${seo.on_page.meta_description.note}</td></tr>
                            <tr><td><strong>H1 Tag</strong></td> <td style="color:${seo.on_page.h1.priority === 'red-flag' ? 'var(--color-red)' : 'inherit'}">${seo.on_page.h1.note}</td></tr>
                            <tr><td><strong>Heading Structure</strong></td> <td style="color:${seo.on_page.headings.priority === 'red-flag' ? 'var(--color-red)' : 'inherit'}">${seo.on_page.headings.note}</td></tr>
                        </tbody>
                    </table>
                </div>

                ${seo.competitor_analysis ? `
                <div class="sub-section">
                    <h3 class="sub-title">Competitor Analysis</h3>
                    ${seo.competitor_analysis.types.map(type => `
                        <div>
                            <h4>${type.type}</h4>
                            <p>${type.description}</p>
                            <ul>
                                ${type.competitors.map(c => `<li>${c.label} (${c.domain})</li>`).join('')}
                            </ul>
                        </div>
                    `).join('<br>')}
                </div>
                ` : ''}

            </div>
            `;
        }
        
        async function downloadPdf() {
            if (!auditDataStore) {
                alert('No audit data available to generate PDF.');
                return;
            }
            
            const btn = document.getElementById('download-pdf-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = 'Generating...';
            btn.disabled = true;

            try {
                const response = await fetch('/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(auditDataStore)
                });

                if (!response.ok) {
                    throw new Error('PDF generation failed on the server.');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                // Extract filename from content-disposition header
                const disposition = response.headers.get('content-disposition');
                let filename = `FF_ELITE_Audit_Report_${Date.now()}.pdf`;
                if (disposition && disposition.indexOf('attachment') !== -1) {
                    const filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                    const matches = filenameRegex.exec(disposition);
                    if (matches != null && matches,[object Object],) {
                        filename = matches,[object Object],replace(/['"]/g, '');
                    }
                }
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                
            } catch (error) {
                alert(`Error: ${error.message}`);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

    </script>
</body>
</html>
