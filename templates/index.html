<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FF Tech AI Website Audit</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

<main class="p-6 max-w-5xl mx-auto">

<h1 class="text-3xl font-bold mb-6">FF Tech â€” Website Audit Platform</h1>

<section class="mb-8 p-4 bg-white dark:bg-gray-800 shadow rounded">
  <h2 class="text-xl font-semibold mb-2">Open Access Audit</h2>
  <form id="audit-form" class="flex gap-2">
    <input id="website-url" type="url" placeholder="https://example.com" class="flex-1 p-2 rounded border border-gray-300" required>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Run Audit</button>
  </form>
</section>

<section class="mb-8 p-4 bg-white dark:bg-gray-800 shadow rounded">
  <h2 class="text-xl font-semibold mb-2">User Registration</h2>
  <form id="register-form" class="flex flex-col gap-2">
    <input id="reg-email" type="email" placeholder="Email" class="p-2 rounded border border-gray-300" required>
    <input id="reg-password" type="password" placeholder="Password (min 8 chars)" class="p-2 rounded border border-gray-300" required>
    <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Register</button>
  </form>
  <div id="register-msg" class="mt-2"></div>
</section>

<section class="mb-8 p-4 bg-white dark:bg-gray-800 shadow rounded">
  <h2 class="text-xl font-semibold mb-2">User Login</h2>
  <form id="login-form" class="flex flex-col gap-2">
    <input id="login-email" type="email" placeholder="Email" class="p-2 rounded border border-gray-300" required>
    <input id="login-password" type="password" placeholder="Password" class="p-2 rounded border border-gray-300" required>
    <button type="submit" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">Login</button>
  </form>
  <div id="login-msg" class="mt-2"></div>
</section>

<section id="summary" class="hidden mb-8 p-4 bg-white dark:bg-gray-800 shadow rounded">
  <h2 class="text-xl font-semibold mb-2">Audit Summary</h2>
  <pre id="out" class="whitespace-pre-wrap"></pre>
  <button id="export-pdf" class="mt-2 bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">Export PDF</button>
</section>

<section id="charts" class="hidden mb-8 p-4 bg-white dark:bg-gray-800 shadow rounded">
  <h2 class="text-xl font-semibold mb-2">Charts</h2>
  <canvas id="overallGauge" class="mb-4"></canvas>
  <canvas id="issuesChart" class="mb-4"></canvas>
  <canvas id="categoryChart" class="mb-4"></canvas>
</section>

<script>
let authToken = null;

// --- Audit Form ---
document.getElementById('audit-form').addEventListener('submit', async e => {
  e.preventDefault();
  const url = document.getElementById('website-url').value;
  const headers = authToken ? { "Authorization": "Bearer " + authToken } : {};
  const res = await fetch('/audit?url=' + encodeURIComponent(url), { headers });
  const data = await res.json();

  document.getElementById('summary').classList.remove('hidden');
  document.getElementById('charts').classList.remove('hidden');
  document.getElementById('out').textContent = JSON.stringify(data, null, 2);

  // Charts
  const overallCtx = document.getElementById('overallGauge').getContext('2d');
  new Chart(overallCtx, { type: 'doughnut', data: data.overall_gauge, options: { responsive:true }});

  const issuesCtx = document.getElementById('issuesChart').getContext('2d');
  new Chart(issuesCtx, { type: 'bar', data: data.issues_chart, options: { responsive:true }});

  const catCtx = document.getElementById('categoryChart').getContext('2d');
  new Chart(catCtx, { type: 'bar', data: data.category_chart, options: { responsive:true }});
});

// --- Export PDF ---
document.getElementById('export-pdf').addEventListener('click', async () => {
  const url = document.getElementById('website-url').value;
  const headers = authToken ? { "Authorization": "Bearer " + authToken } : {};
  const res = await fetch('/export-pdf?url=' + encodeURIComponent(url), { headers });
  const blob = await res.blob();
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'fftech_audit.pdf';
  a.click();
});

// --- Registration ---
document.getElementById('register-form').addEventListener('submit', async e => {
  e.preventDefault();
  const payload = {
    email: document.getElementById('reg-email').value,
    password: document.getElementById('reg-password').value,
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
  };
  const res = await fetch('/register', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  const data = await res.json();
  document.getElementById('register-msg').textContent = data.message || JSON.stringify(data);
});

// --- Login ---
document.getElementById('login-form').addEventListener('submit', async e => {
  e.preventDefault();
  const payload = {
    email: document.getElementById('login-email').value,
    password: document.getElementById('login-password').value
  };
  const res = await fetch('/login', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  const data = await res.json();
  if(data.token){ authToken = data.token; document.getElementById('login-msg').textContent = "Login successful"; }
  else document.getElementById('login-msg').textContent = data.message || "Login failed";
});
</script>

</main>
</body>
</html>
