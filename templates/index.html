import io, time, asyncio, hashlib, os
from typing import List, Dict
from fastapi import FastAPI, Request
from fastapi.responses import HTMLResponse, JSONResponse, StreamingResponse
from fastapi.middleware.cors import CORSMiddleware
from fpdf import FPDF
from bs4 import BeautifulSoup
from urllib.parse import urlparse
import aiohttp
from playwright.async_api import async_playwright

# ---------------- FastAPI App ----------------
app = FastAPI(title="FF TECH ELITE | Real Forensic Engine v6.0")
app.add_middleware(CORSMiddleware, allow_origins=["*"], allow_methods=["*"], allow_headers=["*"])

# ---------------- Metric Descriptions ----------------
METRIC_DESCRIPTIONS = {
    "Performance": "Evaluates server response times, asset delivery speed, and rendering efficiency.",
    "Technical SEO": "Analyzes crawlability, indexing signals, and architecture semantic integrity.",
    "On-Page SEO": "Probes keyword relevance, content depth, and internal linking structures.",
    "Security": "Inspects SSL validity, encryption headers, and vulnerability mitigation.",
    "User Experience": "Measures visual stability, interactivity, and mobile-first design compliance."
}

RAW_METRICS = [(i+1, name, cat) for i, (name, cat) in enumerate([
    # Performance
    ("Largest Contentful Paint (LCP)","Performance"),
    ("First Input Delay (FID)","Performance"),
    ("Cumulative Layout Shift (CLS)","Performance"),
    ("First Contentful Paint (FCP)","Performance"),
    ("Time to First Byte (TTFB)","Performance"),
    ("Total Blocking Time (TBT)","Performance"),
    ("Speed Index","Performance"),
    ("Time to Interactive (TTI)","Performance"),
    ("Total Page Size","Performance"),
    ("HTTP Requests Count","Performance"),
    ("Image Optimization","Performance"),
    ("CSS Minification","Performance"),
    ("JavaScript Minification","Performance"),
    ("GZIP/Brotli Compression","Performance"),
    ("Browser Caching","Performance"),
    # Technical SEO
    ("Mobile Responsiveness","Technical SEO"),
    ("Viewport Configuration","Technical SEO"),
    ("Structured Data Markup","Technical SEO"),
    ("Canonical Tags","Technical SEO"),
    ("Robots.txt Configuration","Technical SEO"),
    ("XML Sitemap","Technical SEO"),
    ("URL Structure","Technical SEO"),
    ("Breadcrumb Navigation","Technical SEO"),
    ("Title Tag Optimization","Technical SEO"),
    ("Meta Description","Technical SEO"),
    ("Heading Structure (H1-H6)","Technical SEO"),
    ("Internal Linking","Technical SEO"),
    ("External Linking Quality","Technical SEO"),
    ("Schema.org Implementation","Technical SEO"),
    ("AMP Compatibility","Technical SEO"),
    # On-Page SEO
    ("Content Quality Score","On-Page SEO"),
    ("Keyword Density Analysis","On-Page SEO"),
    ("Content Readability","On-Page SEO"),
    ("Content Freshness","On-Page SEO"),
    ("Content Length Adequacy","On-Page SEO"),
    ("Image Alt Text","On-Page SEO"),
    ("Video Optimization","On-Page SEO"),
    ("Content Uniqueness","On-Page SEO"),
    ("LSI Keywords","On-Page SEO"),
    ("Content Engagement Signals","On-Page SEO"),
    ("Content Hierarchy","On-Page SEO"),
    # Security
    ("HTTPS Full Implementation","Security"),
    ("Security Headers","Security"),
    ("Cross-Site Scripting Protection","Security"),
    ("SQL Injection Protection","Security"),
    ("Mixed Content Detection","Security"),
    ("TLS/SSL Certificate Validity","Security"),
    ("Cookie Security","Security"),
    ("HTTP Strict Transport Security","Security"),
    ("Content Security Policy","Security"),
    ("Clickjacking Protection","Security"),
    ("Referrer Policy","Security"),
    ("Permissions Policy","Security"),
    ("X-Content-Type-Options","Security"),
    ("Frame Options","Security"),
    # User Experience
    ("Core Web Vitals Compliance","User Experience"),
    ("Mobile-First Design","User Experience"),
    ("Accessibility Compliance","User Experience"),
    ("Page Load Animation","User Experience"),
    ("Navigation Usability","User Experience"),
    ("Form Optimization","User Experience"),
    ("404 Error Page","User Experience"),
    ("Search Functionality","User Experience"),
    ("Social Media Integration","User Experience"),
    ("Multilingual Support","User Experience"),
    ("Progressive Web App Features","User Experience"),
])]

# ---------------- Helper Functions ----------------
def score_bool(cond, ok=100, fail=30):
    return ok if cond else fail

def score_range(val, rules):
    for lim, sc in rules:
        if val <= lim:
            return sc
    return rules[-1][1]

# ---------------- Auditor ----------------
class ForensicAuditor:
    def __init__(self, url):
        self.url = url if url.startswith("http") else "https://" + url
        self.domain = urlparse(self.url).netloc
        self.soup = None
        self.headers = {}
        self.ttfb = 0
        self.page_size = 0
        self.requests_count = 0
        self.images_missing_alt = 0
        self.metrics = {}

    async def fetch_basic(self):
        try:
            async with aiohttp.ClientSession() as session:
                async with session.get(self.url, ssl=False, timeout=15,
                                       headers={"User-Agent":"FFTECH-ForensicBot/6.0"}) as r:
                    self.ttfb = r.headers.get('x-response-time', 0) or 0
                    html = await r.text()
                    self.soup = BeautifulSoup(html,"html.parser")
                    self.headers = dict(r.headers)
                    self.page_size = len(html.encode()) / 1024
                    self.requests_count = len(self.soup.find_all("img")) + len(self.soup.find_all("script")) + len(self.soup.find_all("link"))
                    self.images_missing_alt = len([img for img in self.soup.find_all("img") if not img.get("alt")])
                    return True
        except:
            return False

    async def fetch_cwv(self):
        # Playwright headless browser for Core Web Vitals
        async with async_playwright() as p:
            browser = await p.chromium.launch(headless=True)
            page = await browser.new_page()
            start = time.time()
            try:
                await page.goto(self.url, wait_until='networkidle')
                metrics = await page.evaluate("""() => {
                    const perf = window.performance.timing;
                    const lcp = window.performance.getEntriesByType('largest-contentful-paint');
                    const cls = window.performance.getEntriesByType('layout-shift');
                    return {
                        LCP: lcp.length ? lcp[lcp.length-1].renderTime || lcp[lcp.length-1].loadTime : 0,
                        CLS: cls.length ? cls.map(c=>c.value).reduce((a,b)=>a+b,0) : 0,
                        FCP: perf.responseStart ? perf.responseStart-perf.requestStart : 0,
                        TTI: 0,
                        TBT: 0
                    };
                }""")
                self.metrics.update(metrics)
            finally:
                await browser.close()

# ---------------- PDF ----------------
class ExecutivePDF(FPDF):
    def __init__(self, url, grade):
        super().__init__()
        self.url = url
        self.grade = grade
    def header(self):
        self.set_fill_color(15,23,42)
        self.rect(0,0,210,40,"F")
        self.set_font("Helvetica","B",20)
        self.set_text_color(255,255,255)
        self.cell(0,15,"FF TECH ELITE | EXECUTIVE FORENSIC REPORT",0,1,"C")
        self.set_font("Helvetica","",10)
        self.cell(0,6,self.url,0,1,"C")
        self.ln(10)

# ---------------- Audit Endpoint ----------------
@app.post("/audit")
async def audit(request: Request):
    data = await request.json()
    url = data.get("url", "").strip()
    auditor = ForensicAuditor(url)
    ok = await auditor.fetch_basic()
    if not ok:
        return JSONResponse({"total_grade":1,"summary":"Site Unreachable"})

    await auditor.fetch_cwv()

    # ---------------- Scoring ----------------
    results = []
    pillars = {k:[] for k in METRIC_DESCRIPTIONS}
    s = auditor.soup
    h = auditor.headers

    for i, name, cat in RAW_METRICS:
        if name=="Largest Contentful Paint (LCP)":
            val = auditor.metrics.get("LCP",0)
            sc = score_range(val,[(2500,100),(4000,70),(10000,40)])
        elif name=="Cumulative Layout Shift (CLS)":
            val = auditor.metrics.get("CLS",0)
            sc = score_range(val,[(0.1,100),(0.25,70),(1,40)])
        elif name=="First Contentful Paint (FCP)":
            val = auditor.metrics.get("FCP",0)
            sc = score_range(val,[(2000,100),(4000,70),(10000,40)])
        elif name=="Time to First Byte (TTFB)":
            val = auditor.ttfb
            sc = score_range(val,[(200,100),(600,70),(1500,40)])
        elif name=="Total Page Size":
            val = auditor.page_size
            sc = score_range(val,[(800,100),(2000,70),(5000,40)])
        elif name=="HTTP Requests Count":
            val = auditor.requests_count
            sc = score_range(val,[(50,100),(120,70),(300,40)])
        elif name=="Image Optimization":
            val = auditor.images_missing_alt
            sc = score_range(val,[(0,100),(5,70),(20,40)])
        elif name=="Title Tag Optimization":
            sc = score_bool(s.title and 10<=len(s.title.text)<=60)
        elif name=="Meta Description":
            m = s.find("meta", attrs={"name":"description"})
            sc = score_bool(m and 50<=len(m.get("content",""))<=160)
        elif name=="Heading Structure (H1-H6)":
            sc = score_bool(len(s.find_all("h1"))==1)
        elif name=="HTTPS Full Implementation":
            sc = score_bool(auditor.url.startswith("https"))
        elif name=="HTTP Strict Transport Security":
            sc = score_bool("strict-transport-security" in h)
        elif name=="Content Security Policy":
            sc = score_bool("content-security-policy" in h)
        elif name=="X-Content-Type-Options":
            sc = score_bool("x-content-type-options" in h)
        elif name=="Frame Options":
            sc = score_bool("x-frame-options" in h)
        elif name=="Mobile-First Design":
            sc = score_bool(s.find("meta", attrs={"name":"viewport"}))
        elif name=="Navigation Usability":
            sc = score_bool(s.find("nav"))
        else:
            sc = 70
        sc = max(1,min(100,sc))
        results.append({"no":i,"name":name,"category":cat,"score":sc})
        pillars[cat].append(sc)

    pillar_avg = {k: round(sum(v)/len(v)) for k,v in pillars.items()}
    total = round(sum(pillar_avg.values())/5)

    return {"url":auditor.url,"total_grade":total,"pillars":pillar_avg,"metrics":results,
            "summary":f"Real forensic audit completed. Health Index {total}%."}

# ---------------- Download PDF ----------------
@app.post("/download")
async def download(request: Request):
    d = await request.json()
    pdf = ExecutivePDF(d["url"], d["total_grade"])
    pdf.add_page()
    pdf.set_font("Helvetica","B",40)
    pdf.set_text_color(59,130,246)
    pdf.cell(0,30,f'{d["total_grade"]}%',1,1,"C")
    out = pdf.output(dest="S").encode("latin1")
    return StreamingResponse(io.BytesIO(out),
                             media_type="application/pdf",
                             headers={"Content-Disposition":"attachment; filename=Audit_Report.pdf"})

# ---------------- UI ----------------
@app.get("/", response_class=HTMLResponse)
async def ui():
    with open("dashboard.html","r", encoding="utf-8") as f:
        return f.read()

if __name__=="__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
