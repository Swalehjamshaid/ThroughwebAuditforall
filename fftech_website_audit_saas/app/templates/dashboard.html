
{% extends 'base.html' %}
{% block content %}
<h1 class="h4 mb-3">Dashboard</h1>
{% if not user %}
  <div class="alert alert-warning">Sign in via magic link to view your audits.</div>
{% else %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <div class="fw-bold">{{ user.email }}</div>
      <div class="text-secondary">Plan: {{ 'Subscriber' if user.is_subscriber else 'Free' }}</div>
    </div>
    <form class="d-flex" onsubmit="runAudit(event)">
      <input class="form-control me-2" type="url" id="url" placeholder="https://example.com" required>
      <button class="btn btn-primary">Run Audit</button>
    </form>
  </div>

  <div id="status" class="my-2"></div>

  <div class="table-responsive">
    <table class="table table-sm align-middle">
      <thead><tr><th>ID</th><th>URL</th><th>Score</th><th>Grade</th><th>When</th><th>Actions</th></tr></thead>
      <tbody>
      {% for a in audits %}
        <tr>
          <td>{{ a.id }}</td>
          <td class="text-break" style="max-width:280px">{{ a.url }}</td>
          <td>{{ a.score }}%</td>
          <td><span class="badge bg-success">{{ a.grade }}</span></td>
          <td>{{ a.created_at }}</td>
          <td>
            <a class="btn btn-sm btn-outline-secondary" target="_blank" href="/audit/{{ a.id }}/pdf">PDF</a>
            <a class="btn btn-sm btn-outline-primary" href="/audit/{{ a.id }}/exports">Exports</a>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
{% endif %}

<script>
async function runAudit(e){
  e.preventDefault();
  const email = '{{ user.email if user else "" }}';
  const url = document.getElementById('url').value;
  const status = document.getElementById('status');
  status.innerHTML = 'Running auditâ€¦';
  const res = await fetch('/audit/run-registered', {method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: new URLSearchParams({url, user_email: email})});
  if(!res.ok){
    const err = await res.json();
    status.innerHTML = `<div class="alert alert-danger">${err.detail}</div>`;
    return;
  }
  const data = await res.json();
  status.innerHTML = `<div class="alert alert-success">Audit #${data.id} saved. Refresh to see in the list.</div>`;
}
</script>
{% endblock %}
