
{% extends 'base.html' %}
{% block content %}
<div class="row g-4">
  <div class="col-12 col-lg-8">
    <div class="card mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Recent Trend</h5>
          <a class="btn btn-primary btn-sm" href="/auth/audit/new">New Audit</a>
        </div>
        <canvas id="trendChart" class="mt-3"></canvas>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <h5 class="mb-3">Your Websites</h5>
        {% if websites %}
          <div class="list-group">
            {% for w in websites %}
              <a href="/auth/audit/{{ w.id }}" class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1">{{ w.url }}</h6>
                  <small class="text-muted">{{ w.last_audit_at if w.last_audit_at else '—' }}</small>
                </div>
                <small class="text-muted">Last grade: {{ w.last_grade if w.last_grade else '—' }}</small>
              </a>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted">No websites yet. Start a new audit.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-12 col-lg-4">
    <div class="card mb-4">
      <div class="card-body">
        <h5>Summary</h5>
        <div class="d-flex gap-3 mt-2">
          <div class="p-3 bg-light rounded text-center flex-fill">
            <div class="h3 mb-0">{{ summary.health_score }}</div>
            <small class="text-muted">Health</small>
          </div>
          <div class="p-3 bg-light rounded text-center flex-fill">
            <div class="h3 mb-0">{{ summary.grade }}</div>
            <small class="text-muted">Grade</small>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-body">
        <h5>Email Scheduling</h5>
        {% if schedule.plan == 'free' %}
          <div class="alert alert-warning">Scheduling is a premium feature. Free plan audits used: <b>{{ schedule.audits_used }}</b> / {{ schedule.free_limit }}.</div>
          <a class="btn btn-success" href="/auth/upgrade">Upgrade</a>
        {% else %}
          <form action="/auth/schedule" method="post" class="row g-3">
            <div class="col-6">
              <label class="form-label">Daily Time (HH:MM)</label>
              <input type="text" name="daily_time" class="form-control" value="{{ schedule.daily_time }}" required>
            </div>
            <div class="col-6">
              <label class="form-label">Timezone</label>
              <input type="text" name="timezone" class="form-control" value="{{ schedule.timezone }}" required>
            </div>
            <div class="col-12 form-check">
              <input type="checkbox" class="form-check-input" id="enabled" name="enabled" {% if schedule.enabled %}checked{% endif %}>
              <label for="enabled" class="form-check-label">Enable Daily Email</label>
            </div>
            <div class="col-12">
              <button class="btn btn-primary" type="submit">Save Schedule</button>
            </div>
          </form>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
const labels = {{ trend.labels | tojson }};
const values = {{ trend.values | tojson }};
new Chart(document.getElementById('trendChart'), {
  type: 'line',
  data: { labels, datasets: [{ label: 'Health Score', data: values, borderColor: '#4F46E5', tension: 0.3 }] },
  options: { scales: { y: { beginAtZero: true, max: 100 } } }
});
</script>
{% endblock %}
