{% extends 'base.html' %}

{% block title %}FF Tech AI Website Audit - Professional SaaS Tool{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="text-center mb-5">
    <h1 class="display-4 fw-bold text-white mb-3">AI-Powered Website Audit</h1>
    <p class="lead text-secondary mb-4">
      Get a comprehensive, 5-page certified report on your website's performance, SEO, security, and more.
    </p>
  </div>

  <div class="row g-5">
    <!-- Left Column: Open Access Audit -->
    <div class="col-lg-8">
      <div class="card bg-dark border-0 shadow-lg">
        <div class="card-body p-5">
          <h2 class="h3 fw-bold mb-4 text-white">Quick Audit (No Sign-up Required)</h2>
          <p class="text-secondary mb-4">
            Enter any URL to instantly analyze and generate results.
          </p>

          <form id="openAuditForm" class="row g-3 mb-5">
            <div class="col-md-9">
              <div class="input-group input-group-lg">
                <span class="input-group-text bg-dark border-secondary text-white">
                  <i class="bi bi-globe"></i>
                </span>
                <input 
                  type="url" 
                  class="form-control bg-dark border-secondary text-white" 
                  id="url" 
                  placeholder="https://example.com" 
                  required 
                  autofocus
                />
              </div>
            </div>
            <div class="col-md-3 d-grid">
              <button 
                type="submit" 
                class="btn btn-primary btn-lg fw-bold" 
                id="auditBtn"
              >
                <span id="btnText">Run Audit</span>
                <span id="btnSpinner" class="spinner-border spinner-border-sm d-none ms-2" role="status"></span>
              </button>
            </div>
          </form>

          <!-- Results Section (hidden initially) -->
          <div id="results" class="d-none animate__animated animate__fadeIn">
            <div class="card bg-dark-subtle border-0 shadow">
              <div class="card-body p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                  <h3 class="h4 fw-bold mb-0 text-white">Audit Summary</h3>
                  <div class="d-flex gap-3">
                    <span id="grade" class="badge bg-success px-4 py-2 fs-5 fw-bold"></span>
                    <button id="downloadPdfBtn" class="btn btn-danger btn-sm">
                      <i class="bi bi-file-pdf me-1"></i> Download 5-Page PDF
                    </button>
                  </div>
                </div>

                <!-- Overall Score -->
                <div class="mb-4">
                  <label class="form-label d-flex justify-content-between text-white">
                    Overall Performance <span id="scoreText" class="fw-bold">0%</span>
                  </label>
                  <div class="progress" style="height: 14px; background: #333;">
                    <div id="scoreBar" class="progress-bar bg-gradient bg-success progress-bar-striped progress-bar-animated" style="width: 0%"></div>
                  </div>
                </div>

                <!-- Radar Chart -->
                <canvas id="catChart" height="200"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column: Registered Access -->
    <div class="col-lg-4">
      <div class="card bg-dark border-0 shadow-lg">
        <div class="card-body p-5">
          <h2 class="h4 fw-bold mb-4 text-white">Registered Access</h2>
          <p class="text-secondary mb-4 small">
            Sign in to save audit history, export CSV/PPTX summaries, and unlock unlimited audits.
          </p>

          <form id="magicForm">
            <div class="mb-4">
              <input 
                type="email" 
                class="form-control bg-dark border-secondary text-white" 
                id="email" 
                placeholder="you@example.com" 
                required 
              />
            </div>
            <button type="submit" class="btn btn-outline-light w-100">
              Send Magic Link
            </button>
          </form>

          <div id="magicStatus" class="mt-4"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Icons CDN -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<script>
  const openForm = document.getElementById('openAuditForm');
  const auditBtn = document.getElementById('auditBtn');
  const btnText = document.getElementById('btnText');
  const btnSpinner = document.getElementById('btnSpinner');
  const resultsDiv = document.getElementById('results');
  const scoreBar = document.getElementById('scoreBar');
  const scoreText = document.getElementById('scoreText');
  const gradeEl = document.getElementById('grade');
  const downloadPdfBtn = document.getElementById('downloadPdfBtn');

  let catChart = null;

  openForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Loading state
    btnText.textContent = 'Analyzing...';
    btnSpinner.classList.remove('d-none');
    auditBtn.disabled = true;
    resultsDiv.classList.add('d-none');

    const url = document.getElementById('url').value.trim();

    try {
      const res = await fetch('/audit/run', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url })
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || 'Audit failed');
      }

      const data = await res.json();

      // Show results
      resultsDiv.classList.remove('d-none');

      // Update score & grade
      const roundedScore = Math.round(data.score);
      scoreBar.style.width = roundedScore + '%';
      scoreText.textContent = roundedScore + '%';
      gradeEl.textContent = 'Grade: ' + data.grade;
      gradeEl.className = `badge px-4 py-2 fs-5 fw-bold ${data.grade.startsWith('A') ? 'bg-success' : data.grade.startsWith('B') ? 'bg-info' : 'bg-warning'}`;

      // Render radar chart
      const labels = Object.keys(data.categories);
      const values = Object.values(data.categories);

      if (catChart) catChart.destroy();

      catChart = new Chart(document.getElementById('catChart'), {
        type: 'radar',
        data: {
          labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
          datasets: [{
            label: 'Score',
            data: values,
            backgroundColor: 'rgba(13, 110, 253, 0.2)',
            borderColor: '#0d6efd',
            borderWidth: 2,
            pointBackgroundColor: '#0d6efd'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            r: {
              beginAtZero: true,
              max: 100,
              ticks: { stepSize: 20 }
            }
          }
        }
      });

      // Store current data for PDF download
      window.currentAuditData = { url, data };

    } catch (err) {
      alert('Error: ' + err.message);
    } finally {
      btnText.textContent = 'Run Audit';
      btnSpinner.classList.add('d-none');
      auditBtn.disabled = false;
    }
  });

  // PDF Download Button
  downloadPdfBtn.addEventListener('click', async () => {
    if (!window.currentAuditData) {
      alert('Please run an audit first');
      return;
    }

    const { url } = window.currentAuditData;

    try {
      const res = await fetch('/audit/generate-pdf', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ url })
      });

      if (!res.ok) throw new Error('PDF generation failed');

      const blob = await res.blob();
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `FFTech_Audit_${url.replace(/^https?:\/\//, '').replace(/\//g, '_')}.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (err) {
      alert('PDF download failed: ' + err.message);
    }
  });

  // Magic Link Form
  document.getElementById('magicForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value.trim();
    const statusEl = document.getElementById('magicStatus');

    try {
      const res = await fetch('/auth/login-link', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.detail || 'Failed to send link');
      }

      statusEl.innerHTML = '<div class="alert alert-success py-2 small">Magic link sent! Check your email.</div>';
    } catch (err) {
      statusEl.innerHTML = `<div class="alert alert-danger py-2 small">${err.message}</div>`;
    }
  });
</script>
{% endblock %}
