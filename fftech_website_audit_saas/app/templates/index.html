{% extends 'base.html' %}
{% block content %}
<div class="container mt-5">
    <div class="card p-4 shadow-sm">
        <form id="auditForm">
            <div class="input-group">
                <input type="url" id="url" class="form-control" placeholder="https://example.com" required>
                <button class="btn btn-primary" type="submit" id="btn">
                    <span id="spin" class="spinner-border spinner-border-sm d-none"></span> Run Audit
                </button>
            </div>
        </form>
    </div>

    <div id="results" class="mt-4 d-none">
        <div class="card p-4">
            <div class="d-flex justify-content-between">
                <h3>Score: <span id="score"></span> (<span id="grade"></span>)</h3>
                <button id="pdfBtn" class="btn btn-danger">Download PDF</button>
            </div>
            <canvas id="chart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chart;
let lastId;
document.getElementById('auditForm').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('btn');
    const spin = document.getElementById('spin');
    btn.disabled = true; spin.classList.remove('d-none');

    const res = await fetch('/audit/run', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({url: document.getElementById('url').value})
    });
    
    const data = await res.json();
    lastId = data.id;
    btn.disabled = false; spin.classList.add('d-none');
    document.getElementById('results').classList.remove('d-none');
    document.getElementById('score').innerText = data.score + '%';
    document.getElementById('grade').innerText = data.grade;

    if(chart) chart.destroy();
    chart = new Chart(document.getElementById('chart'), {
        type: 'bar',
        data: {
            labels: Object.keys(data.categories),
            datasets: [{label: 'Scores', data: Object.values(data.categories), backgroundColor: '#0AD1A3'}]
        }
    });
};

document.getElementById('pdfBtn').onclick = () => {
    window.open(`/audit/${lastId}/pdf`, '_blank');
};
</script>
{% endblock %}
