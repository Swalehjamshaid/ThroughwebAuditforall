{% extends 'base.html' %}
{% block content %}
<div class="row g-4">
  <div class="col-lg-8">
    <div class="card shadow-sm border-0">
      <div class="card-body p-4">
        <h1 class="h4 mb-3">AI-Powered Website Audit</h1>
        <p class="text-secondary">Enter a website URL to generate a comprehensive 5-page certified report.</p>
        
        <form id="openAuditForm" class="row g-2">
          <div class="col-md-9">
            <div class="input-group">
              <span class="input-group-text bg-white"><i class="bi bi-globe"></i></span>
              <input type="url" class="form-control form-control-lg" id="url" placeholder="https://example.com" required />
            </div>
          </div>
          <div class="col-md-3 d-grid">
            <button class="btn btn-primary btn-lg" type="submit" id="auditBtn">
              <span id="btnText">Run Audit</span>
              <span id="btnSpinner" class="spinner-border spinner-border-sm d-none" role="status"></span>
            </button>
          </div>
        </form>
      </div>
    </div>

    <div id="results" class="mt-4 d-none">
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          <div class="d-flex align-items-center justify-content-between mb-4">
            <h2 class="h5 mb-0">Audit Summary</h2>
            <div class="d-flex gap-2">
                <span class="badge bg-primary px-3 py-2" id="grade"></span>
                <button id="downloadPdfBtn" class="btn btn-sm btn-outline-danger">
                    <i class="bi bi-file-pdf"></i> Download PDF Report
                </button>
            </div>
          </div>
          
          <div class="row mb-4">
            <div class="col-md-12">
                <label class="form-label d-flex justify-content-between">
                    Overall Performance <span id="scoreText" class="fw-bold">0%</span>
                </label>
                <div class="progress" style="height: 12px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated bg-success" id="scoreBar" style="width: 0%"></div>
                </div>
            </div>
          </div>
          
          <canvas id="catChart" height="120"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card shadow-sm border-0">
      <div class="card-body p-4">
        <h2 class="h5 mb-3">Registered Access</h2>
        <p class="small text-secondary mb-4">Sign in via Magic Link to save history and export CSV/PPTX summaries.</p>
        <form id="magicForm">
          <div class="mb-3">
            <input type="email" class="form-control" id="email" placeholder="you@example.com" required />
          </div>
          <button class="btn btn-dark w-100">Send Magic Link</button>
        </form>
        <div id="magicStatus" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

<script>
  const form = document.getElementById('openAuditForm');
  const auditBtn = document.getElementById('auditBtn');
  const btnText = document.getElementById('btnText');
  const btnSpinner = document.getElementById('btnSpinner');
  const results = document.getElementById('results');
  const scoreBar = document.getElementById('scoreBar');
  const scoreText = document.getElementById('scoreText');
  const gradeEl = document.getElementById('grade');
  const downloadPdfBtn = document.getElementById('downloadPdfBtn');
  
  let catChart;
  let currentAuditData = null;

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    
    // UI Loading State
    btnText.textContent = "Analyzing...";
    btnSpinner.classList.remove('d-none');
    auditBtn.disabled = true;
    results.classList.add('d-none');

    const url = document.getElementById('url').value;
    
    try {
        // FIX: Sending as JSON to match the updated AuditRequest model
        const res = await fetch('/audit/run', {
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ url: url })
        });

        const data = await res.json();

        if (!res.ok) throw new Error(data.detail || "Audit Failed");

        currentAuditData = data;
        
        // Update UI
        results.classList.remove('d-none');
        const roundedScore = Math.round(data.score);
        scoreBar.style.width = roundedScore + '%';
        scoreText.textContent = roundedScore + '%';
        gradeEl.textContent = "Grade: " + data.grade;

        // Render Chart
        const labels = Object.keys(data.categories);
        const values = labels.map(k => data.categories[k]);
        if (catChart) catChart.destroy();
        catChart = new Chart(document.getElementById('catChart'), {
          type: 'bar',
          data: { 
            labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)), 
            datasets: [{ 
                label: 'Score', 
                data: values, 
                backgroundColor: '#0d6efd',
                borderRadius: 5
            }]
          },
          options: { 
            responsive: true,
            scales: { y: { beginAtZero: true, max: 100 }}
          }
        });

    } catch (err) {
        alert("Error: " + err.message);
    } finally {
        btnText.textContent = "Run Audit";
        btnSpinner.classList.add('d-none');
        auditBtn.disabled = false;
    }
  });

  // NEW: Function to handle PDF Download
  downloadPdfBtn.addEventListener('click', () => {
      if (!currentAuditData) return;
      // For Open Audit, we generate a PDF using the URL directly
      // Adjust this URL if your backend has a specific 'open-pdf' route
      window.open(`/audit/open/pdf?url=${encodeURIComponent(currentAuditData.url)}`, '_blank');
  });

  // Magic Link Logic
  const magicForm = document.getElementById('magicForm');
  magicForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const email = document.getElementById('email').value;
    const res = await fetch('/auth/login-link', {
        method:'POST', 
        headers:{'Content-Type':'application/json'}, 
        body: JSON.stringify({email})
    });
    const statusEl = document.getElementById('magicStatus');
    if(!res.ok){
      const err = await res.json();
      statusEl.innerHTML = `<div class="alert alert-danger py-2 small">${err.detail || 'Failed'}</div>`;
      return;
    }
    statusEl.innerHTML = `<div class="alert alert-success py-2 small">Link sent! Check your email.</div>`;
  });
</script>
{% endblock %}
