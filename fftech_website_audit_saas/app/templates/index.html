let myChart; // Global variable to hold the chart instance

async function startAudit() {
    const url = document.getElementById('auditUrl').value;
    if(!url) return alert("Please enter a URL");

    // Show loading state in the Grade box
    document.getElementById('gradeValue').innerText = "...";

    const response = await fetch(`/audit/run?url=${encodeURIComponent(url)}`, { method: 'POST' });
    const data = await response.json();

    if (data.id) {
        // 1. Update the Big Grade
        document.getElementById('gradeValue').innerText = data.grade;
        
        // 2. Update the Graphical Chart
        updateChart(data.categories);
        
        // 3. Store ID for PDF download
        window.currentAuditId = data.id;
    }
}

function updateChart(categoryData) {
    const ctx = document.getElementById('auditChart').getContext('2d');
    
    if (myChart) { myChart.destroy(); } // Clear old data

    myChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(categoryData),
            datasets: [{
                label: 'Audit Score %',
                data: Object.values(categoryData),
                backgroundColor: '#0AD1A3', // Your brand color
                borderColor: '#0AD1A3',
                borderWidth: 1,
                borderRadius: 5
            }]
        },
        options: {
            scales: { y: { beginAtZero: true, max: 100 } }
        }
    });
}

function downloadReport() {
    if (!window.currentAuditId) return alert("Run an audit first!");
    window.location.href = `/audit/${window.currentAuditId}/pdf`;
}
