
{% extends "base.html" %}
{% block title %}Audit Results · {{ UI_BRAND_NAME }}{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css057D9;--accent:#1ABC9C;--warning:#FF9F1C;--danger:#FF4D4D;--purple:#8E44AD}
  body{background:#0F172A}
  .glass{background:rgba(255,255,255,0.06);backdrop-filter:blur(8px);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.18);border:1px solid rgba(255,255,255,.08)}
  .text-muted-2{color:#94a3b8}
  .kpi{display:flex;align-items:center;gap:.75rem}
  .progress{height:10px;background:rgba(255,255,255,.12)}
  .progress-bar{background:var(--accent)}
  .badge{border-radius:8px}
  .btn-primary{background:var(--primary);border-color:var(--primary)}
  .btn-outline-primary{border-color:var(--primary);color:var(--primary)}
  .btn-outline-primary:hover{background:var(--primary);color:#fff}
  .card-title{font-weight:600;color:#fff}
  .card-subtitle{color:#cbd5e1}
</style>
{% endblock %}

{% block body %}
<div class="container py-4 py-md-5">
  <div class="d-flex align-items-center justify-content-between mb-4">
    <h2 class="text-white mb-0">
      <i class="fas fa-shield-halved me-2"></i> {{ UI_BRAND_NAME }} AI Website Audit
    </h2>
    <div>
      {% if website.id %}
      <a class="btn btn-outline-primary me-2" href="/auth/audit/run/{{ website.ide-run Audit
      </a>
      <a class="btn btn-primary" href="/auth/report/pdf/{{ website.id-pdf me-1"></i> Certified PDF
      </a>
      {% else %}
      <a class="btn btn-outline-primary" href="/report/pdf/open?url={{ website.urlle-pdf me-1"></i> Download PDF (Open)
      </a>
      {% endif %}
    </div>
  </div>

  <!-- Executive Summary & Grade -->
  <div class="row g-3">
    <div class="col-lg-8">
      <div class="card glass p-3 p-md-4 h-100">
        <div class="d-flex align-items-center justify-content-between">
          <div class="kpi">
            <span class="badge bg-primary">Grade</span>
            <h3 class="text-white mb-0">{{ audit.grade }}</h3>
          </div>
          <div class="kpi">
            <span class="badge bg-success">Health</span>
            <h3 class="text-white mb-0">{{ audit.health_score }}/100</h3>
          </div>
        </div>
        <p class="text-muted-2 mt-3 mb-0"><i class="fas fa-link me-1"></i>{{ website.url }}</p>
        <hr class="border-secondary" />
        <h5 class="card-title mb-2"><i class="fas fa-scroll me-2"></i> Executive Summary</h5>
        <p class="text-muted-2 mb-0">{{ audit.exec_summary }}</p>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card glass p-3 p-md-4 h-100">
        <h5 class="card-title mb-3"><i class="fas fa-chart-radar me-2"></i> Category Scores</h5>
        {% for item in audit.category_scores %}
          {% set color = ('#0057D9' if item.name=='Performance' else
                          '#1ABC9C' if item.name=='Accessibility' else
                          '#FF9F1C' if item.name=='SEO' else
                          '#FF4D4D' if item.name=='Security' else '#8E44AD') %}
          <div class="d-flex justify-content-between">
            <span class="text-white-50">{{ item.name }}</span>
            <span class="text-white">{{ item.score }}</span>
          </div>
          <div class="progress mb-2">
            <div class="progress-bar" role="progressbar"
                 style="width: {{ item.score }}%; background: {{ color }}"></div>
          </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="row g-3 mt-1">
    <div class="col-lg-6">
      <div class="card glass p-3 p-md-4">
        <h5 class="card-title"><i class="fas fa-chart-simple me-2"></i> Radar: Categories</h5>
        <canvas id="radarChart" height="200"></canvas>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="card glass p-3 p-md-4">
        <h5 class="card-title"><i class="fas fa-chart-bar me-2"></i> Scores by Category</h5>
        <canvas id="hbarChart" height="200"></canvas>
      </div>
    </div>
  </div>

  <div class="row g-3 mt-1">
    <div class="col-lg-4">
      <div class="card glass p-3 p-md-4">
        <h5 class="card-title"><i class="fas fa-signal me-2"></i> Status Code</h5>
        <canvas id="doughnutChart" height="180"></canvas>
        <p class="text-muted-2 mt-2 mb-0">
          <small>Distribution based on latest fetch (2xx/3xx/4xx/5xx).</small>
        </p>
      </div>
    </div>
    <div class="col-lg-8">
      <div class="card glass p-3 p-md-4">
        <h5 class="card-title"><i class="fas fa-wave-square me-2"></i> Health Trend</h5>
        <canvas id="trendChart" height="160"></canvas>
        {% if is_open %}
          <p class="text-muted-2 mt-2 mb-0"><small>No history for open access audits.</small></p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Strengths / Weak / Priority -->
  <div class="row g-3 mt-1">
    <div class="col-lg-4">
      <div class="card glass p-3 p-md-4">
        <h5 class="card-title"><i class="fas fa-thumbs-up me-2"></i> Strengths</h5>
        <ul class="text-muted-2 mb-0">
          {% for x in audit.panels.strengths %}<li>{{ x }}</li>{% endfor %}
        </ul>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card glass p-3 p-md-4">
        <h5 class="card-title"><i class="fas fa-exclamation-triangle me-2"></i> Weak Areas</h5>
        <ul class="text-muted-2 mb-0">
          {% for x in audit.panels.weak %}<li>{{ x }}</li>{% endfor %}
        </ul>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="card glass p-3 p-md-4">
        <h5 class="card-title"><i class="fas fa-fire me-2"></i> Priority Fixes</h5>
        <ul class="text-muted-2 mb-0">
          {% for x in audit.panels.priority %}<li>{{ x }}</li>{% endfor %}
        </ul>
      </div>
    </div>
  </div>

  <!-- Actionable Roadmap -->
  <div class="mt-4">
    <h4 class="text-white mb-3"><i class="fas fa-route me-2"></i> Actionable Roadmap</h4>
    {% set issues = audit.top_issues if audit.top_issues else [
      'Missing sitemap.xml','Missing HSTS header','Images missing alt attributes',
      'No canonical link tag','robots.txt blocking important pages','Mixed content over HTTPS',
      'Duplicate title tags','Meta description too short'
    ] %}
    <div class="row">
      {% for issue in issues %}
        {% set lower = issue|lower %}
        {% if 'https' in lower or 'ssl' in lower or 'mixed content' in lower or '5xx' in lower or '4xx' in lower %}
          {% set border = 'var(--danger)' %}{% set badge = 'bg-danger' %}{% set label = 'CRITICAL' %}
        {% elif 'canonical' in lower or 'robots' in lower or 'title' in lower or 'meta' in lower or 'sitemap' in lower or 'alt' in lower %}
          {% set border = 'var(--warning)' %}{% set badge = 'bg-warning text-dark' %}{% set label = 'HIGH IMPACT' %}
        {% else %}
          {% set border = 'var(--accent)' %}{% set badge = 'bg-success' %}{% set label = 'OPTIMIZATION' %}
        {% endif %}
        <div class="col-md-6 mb-3">
          <div class="card glass h-100" style="border-left: 6px solid {{ border }};">
            <div class="card-body">
              <div class="d-flex justify-content-between">
                <span class="badge {{ badge }}">{{ label }}</span>
                <span class="text-muted-2 small"><i class="fas fa-tools me-1"></i>Technical</span>
              </div>
              <p class="text-white mb-1"><strong>Issue:</strong> {{ issue }}</p>
              <p class="text-muted-2 small mb-2">
                <strong>Recommendation:</strong>
                {% if 'https' in lower and 'mixed' in lower %}
                  Serve all assets over HTTPS, remove http:// references, enable HSTS, and update CDN URLs.
                {% elif 'https' in lower or 'ssl' in lower %}
                  Install valid TLS, force HTTPS with 301, enable HSTS, and fix internal links to HTTPS.
                {% elif 'title' in lower %}
                  Keep titles unique (50–60 chars), lead with primary keyword, remove duplication.
                {% elif 'meta' in lower %}
                  Write unique 140–160 char descriptions; fix duplicates/too-short entries.
                {% elif 'canonical' in lower %}
                  Add one canonical per page to preferred URL; fix parameter/duplicate variants.
                {% elif 'robots' in lower %}
                  Review robots.txt & meta robots; unblock essential pages; avoid noindex on key content.
                {% elif 'alt' in lower %}
                  Provide descriptive alt text for all images to improve accessibility & SEO.
                {% elif 'sitemap' in lower %}
                  Generate sitemap.xml with indexable URLs, host at /sitemap.xml, reference in robots.txt.
                {% else %}
                  Implement technical optimization to improve crawlability, indexation, and stability.
                {% endif %}
              </p>
              <div class="d-flex gap-2">
                <a classdevelopers.google.com/search/docs/fundamentals/seo-starter-guide
                  <i class="fas fa-book-open me-1"></i> Fix Guide
                </a>
                {% if website.id %}
                  /auth/audit/run/{{ website.id }}
                    <i class="fas fa-redo me-1"></i> Re-run after Fix
                  </a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  </div>

  <!-- Technical Metrics (selected, never empty due to backend defaults) -->
  <div class="mt-4">
    <div class="card glass p-3 p-md-4">
      <h5 class="card-title"><i class="fas fa-gauge-high me-2"></i> Technical Metrics</h5>
      <div class="row">
        {% for k, v in audit.metrics.items() %}
          {% if loop.index0 < 12 %}
            <div class="col-md-4 mb-2">
              <div class="d-flex justify-content-between">
                <span class="text-white-50">{{ k }}</span>
                <span class="text-white">{{ v }}</span>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
      <p class="text-muted-2 mb-0"><small>Full metric list is available in the certified PDF.</small></p>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.jsript>
  // Parse chart configs from backend (JSON strings)
  const radarCfg    = JSON.parse('{{ charts.radar | safe }}');
  const hbarCfg     = JSON.parse('{{ charts.hbar | safe }}');
  const doughnutCfg = JSON.parse('{{ charts.doughnut | safe }}');
  const trendCfg    = JSON.parse('{{ charts.trend | safe }}');

  new Chart(document.getElementById('radarChart'), radarCfg);
  new Chart(document.getElementById('hbarChart'), hbarCfg);
  new Chart(document.getElementById('doughnutChart'), doughnutCfg);
  new Chart(document.getElementById('trendChart'), trendCfg);
</script>
{% endblock %}
``
