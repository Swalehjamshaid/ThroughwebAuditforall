
# db_config.py
import os
from urllib.parse import urlparse

def get_database_url() -> str:
    url = os.getenv("DATABASE_URL") or os.getenv("SQLALCHEMY_DATABASE_URI")
    if not url or not url.strip():
        raise RuntimeError("DATABASE_URL is not set")

    # Normalize common Postgres variants
    if url.startswith("postgres://"):
        # Convert old Heroku-style scheme to SQLAlchemy 2.x + psycopg
        url = url.replace("postgres://", "postgresql+psycopg://", 1)
    elif url.startswith("postgresql://") and "+psycopg" not in url and "+psycopg2" not in url:
        url = url.replace("postgresql://", "postgresql+psycopg://", 1)

    # Basic validation: scheme/host/dbname must exist
    parsed = urlparse(url)
    if not parsed.scheme or not parsed.hostname or not parsed.path or parsed.path == "/":
        raise RuntimeError(f"Invalid DATABASE_URL format: {url}")

    return url
