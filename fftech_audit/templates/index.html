
<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>FF Tech AI Website Audit SaaS</title>
https://cdn.jsdelivr.net/npm/chart.js</script>
<style>
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0f172a;color:#e2e8f0;margin:0}
header{background:#0a2540;padding:16px 24px;display:flex;justify-content:space-between;align-items:center}
.brand{font-weight:800;letter-spacing:0.5px}
main{padding:24px}
.card{background:#111827;border:1px solid #334155;border-radius:12px;padding:16px;margin-bottom:16px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
.btn{background:#2563eb;color:white;border:none;border-radius:8px;padding:10px 14px;cursor:pointer}
.input{width:100%;padding:10px;border-radius:8px;border:1px solid #334155;background:#0b1220;color:#e2e8f0}
.badge{display:inline-block;background:#1f2937;padding:6px 10px;border-radius:999px;margin-right:8px}
.progress{background:#334155;border-radius:8px;height:12px;width:100%;overflow:hidden}
.progress>div{height:100%;background:#16a34a}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #334155}
footer{padding:24px;text-align:center;color:#93c5fd}
small{color:#93c5fd}
a{color:#93c5fd}
</style>
</head>
<body>
<header>
  <div class="brand">FF TECH AI • Website Audit</div>
  <div>
    <button class="btn" onclick="showLogin()">Login (Magic Link / OTP)</button>
    <button class="btn" onclick="logout()">Logout</button>
  </div>
</header>
<main>
  <div class="card" id="loginCard" style="display:none">
    <h3>Passwordless Login</h3>
    <form onsubmit="requestLink(event)">
      <input id="emailInput" type="email" class="input" placeholder="you@example.com" required />
      <button class="btn">Send Magic Link</button>
    </form>
    <form onsubmit="requestCode(event)" style="margin-top:10px">
      <input id="emailCode" type="email" class="input" placeholder="you@example.com" required />
      <button class="btn">Send Code (OTP)</button>
    </form>
    <form onsubmit="verifyCode(event)" style="margin-top:10px">
      <input id="codeInput" class="input" placeholder="Enter code" required />
      <button class="btn">Verify Code & Login</button>
    </form>
    <small>Magic link or OTP — both supported.</small>
  </div>

  <div class="card">
    <form onsubmit="runOpenAudit(event)">
      <label>Open Access Audit (no login)</label>
      <input id="urlOpen" class="input" type="url" placeholder="https://example.com" required />
      <button class="btn">Run Audit</button>
      <span id="loadingOpen" style="margin-left:10px;display:none">Running...</span>
    </form>
  </div>

  <div class="card">
    <form onsubmit="runUserAudit(event)">
      <label>Registered Audit (logged-in users)</label>
      <input id="urlUser" class="input" type="url" placeholder="https://example.com" required />
      <button class="btn">Run & Save Audit</button>
      <span id="loadingUser" style="margin-left:10px;display:none">Running...</span>
    </form>
    <small>Free plan: 10 audits; Pro: scheduling & long-term history.</small>
  </div>

  <div class="grid">
    <div class="card"><h3>Executive Summary</h3><p id="summary"></p></div>
    <div class="card"><h3>Score & Grade</h3>
      <div id="scoreGrade"></div>
      <div class="progress"><div id="scoreBar" style="width:0%"></div></div>
      <canvas id="catChart" height="160"></canvas>
    </div>
    <div class="card"><h3>Severity</h3><div id="severity"></div></div>
  </div>

  <div class="card"><h3>Category Charts</h3>
    <div class="grid">
      <div><canvas id="chartCrawl"></canvas></div>
      <div><canvas id="chartSEO"></canvas></div>
      <div><canvas id="chartPerf"></canvas></div>
      <div><canvas id="chartSec"></canvas></div>
      <div><canvas id="chartMobile"></canvas></div>
    </div>
  </div>

  <div class="card">
    <h3>All Metrics (1–200)</h3>
    <table id="metricsTable"><thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Value</th><th>Detail</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="card">
    <h3>My Audit History</h3>
    <button class="btn" onclick="loadHistory()">Refresh</button>
    <table id="historyTable"><thead><tr><th>ID</th><th>URL</th><th>Score</th><th>Grade</th><th>Date</th><th>PDF</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="card">
    <h3>Scheduling (Pro)</h3>
    <form onsubmit="createSchedule(event)">
      <input id="scheduleUrl" class="input" type="url" placeholder="https://example.com" required />
      <select id="scheduleFreq" class="input"><option value="daily">daily</option><option value="weekly" selected>weekly</option><option value="monthly">monthly</option></select>
      <button class="btn">Create Schedule</button>
    </form>
    <button class="btn" onclick="listSchedules()">List Schedules</button>
    <ul id="schedules"></ul>
    <small>Scheduled audits email PDFs if SMTP is configured.</small>
  </div>
</main>
<footer>FF Tech • API-driven • Charts by Chart.js (CDN) • Health: /health/health</a></footer>

<script>
function token(){ return localStorage.getItem('fftech_token') || ''; }
function showLogin(){ document.getElementById('loginCard').style.display='block'; }
function logout(){ localStorage.removeItem('fftech_token'); alert('Logged out'); }

async function requestLink(e){ e.preventDefault();
  const email = document.getElementById('emailInput').value;
  const res = await fetch('/auth/request-link',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})});
  const d = await res.json(); alert(d.message || 'Magic link sent / logged. Check email or server logs.');
}

async function requestCode(e){ e.preventDefault();
  const email = document.getElementById('emailCode').value;
  const res = await fetch('/auth/request-code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email})});
  const d = await res.json(); alert(d.message || 'Code sent / logged.');
}

async function verifyCode(e){ e.preventDefault();
  const email = document.getElementById('emailCode').value; const code = document.getElementById('codeInput').value;
  const res = await fetch('/auth/verify-code',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,code})});
  const d = await res.json(); if(res.ok){ localStorage.setItem('fftech_token', d.token); alert('Logged in via code!'); } else { alert(d.detail || 'Failed'); }
}

function chartDonut(id,val){ new Chart(document.getElementById(id),{type:'doughnut',
  data:{labels:['Score','Remaining'],datasets:[{data:[val,100-val],backgroundColor:['#16a34a','#334155']}]},
  options:{plugins:{legend:{display:false}}}}); }

function render(d){
  document.getElementById('summary').textContent = d.metrics[3].value;
  document.getElementById('scoreGrade').innerHTML = `<span class="badge">Score: ${d.score}%</span><span class="badge">Grade: ${d.grade}</span>`;
  document.getElementById('scoreBar').style.width = d.score + '%';
  const sev = d.metrics[7].value;
  document.getElementById('severity').innerHTML = `<span class="badge">Errors: ${sev.errors}</span><span class="badge">Warnings: ${sev.warnings}</span><span class="badge">Notices: ${sev.notices}</span>`;
  const cat=d.metrics[8].value;
  new Chart(document.getElementById('catChart'),{type:'bar',data:{labels:Object.keys(cat),datasets:[{data:Object.values(cat),backgroundColor:'#2E86C1'}]},options:{scales:{y:{min:0,max:100}}}});
  chartDonut('chartCrawl',cat['Crawlability']); chartDonut('chartSEO',cat['On-Page SEO']); chartDonut('chartPerf',cat['Performance']); chartDonut('chartSec',cat['Security']); chartDonut('chartMobile',cat['Mobile']);

  const tbody=document.getElementById('metricsTable').querySelector('tbody'); tbody.innerHTML='';
  const entries=Object.entries(d.metrics).sort((a,b)=>parseInt(a[0])-parseInt(b[0]));
  fetch('/api/metrics/descriptors').then(r=>r.json()).then(DESCRIPTORS=>{
    for(const [id,obj] of entries){
      const desc=DESCRIPTORS[id]||{name:'(Unknown)',category:'-'};
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${id}</td><td>${desc.name}</td><td>${desc.category}</td><td>${(typeof obj.value==='object')? JSON.stringify(obj.value): obj.value}</td><td>${obj.detail||''}</td>`;
      tbody.appendChild(tr);
    }
  });
}

async function runOpenAudit(e){ e.preventDefault();
  const url=document.getElementById('urlOpen').value; document.getElementById('loadingOpen').style.display='inline';
  try{ const r=await fetch('/api/audit/open',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url})}); const d=await r.json();
    if(r.ok){ render(d); } else { alert(d.detail||'Audit failed'); }
  }catch(err){ alert('Error: '+err); } finally{ document.getElementById('loadingOpen').style.display='none'; }
}

async function runUserAudit(e){ e.preventDefault();
  const t=token(); if(!t){ alert('Please login first.'); return; }
  const url=document.getElementById('urlUser').value; document.getElementById('loadingUser').style.display='inline';
  try{ const r=await fetch('/api/audit/user',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+t},body:JSON.stringify({url})}); const d=await r.json();
    if(r.ok){ render(d); alert('Audit saved. ID: '+d.audit_id); } else { alert(d.detail||'Audit failed'); }
  }catch(err){ alert('Error: '+err); } finally{ document.getElementById('loadingUser').style.display='none'; }
}

async function loadHistory(){
  const t=token(); if(!t){ alert('Login required'); return; }
  const r=await fetch('/api/audits',{headers:{'Authorization':'Bearer '+t}}); const d=await r.json();
  const tbody=document.getElementById('historyTable').querySelector('tbody'); tbody.innerHTML='';
  for(const a of d){
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${a.id}</td><td>${a.url}</td><td>${a.score}</td><td>${a.grade}</td><td>${a.created_at}</td><td>/api/report/${a.id}.pdfPDF</a></td>`;
    tbody.appendChild(tr);
  }
}

async function createSchedule(e){
  e.preventDefault(); const t=token(); if(!t){ alert('Login required'); return; }
  const url=document.getElementById('scheduleUrl').value; const frequency=document.getElementById('scheduleFreq').value;
  const r=await fetch('/schedule',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+t},body:JSON.stringify({url,frequency})}); const d=await r.json();
  if(r.ok){ alert('Scheduled: '+d.schedule_id); } else { alert(d.detail||'Failed'); }
}

async function listSchedules(){
  const t=token(); if(!t){ alert('Login required'); return; }
  const r=await fetch('/schedule',{headers:{'Authorization':'Bearer '+t}}); const d=await r.json();
  const ul=document.getElementById('schedules'); ul.innerHTML='';
  for(const s of d){
    const li=document.createElement('li'); li.textContent=`#${s.id} ${s.url} (${s.frequency}) next: ${s.next_run_at}`;
    ul.appendChild(li);
  }
}

// If redirected with ?token=..., auto verify & store session token
(function(){
  const params=new URLSearchParams(location.search);
  const tok=params.get('token'); if(tok){
    fetch('/auth/verify-link',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({token: tok})})
      .then(r=>r.json()).then(d=>{
        if(d.token){ localStorage.setItem('fftech_token', d.token); alert('Logged in via magic link!'); history.replaceState({},'',location.pathname); }
      });
  }
})();
</script>
</body></html>
